<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TipKeeper App - Cloud Dashboard</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase SDKs (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- Estilos Personalizados -->
    <style>
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes slideInFromTop { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        @keyframes flashSuccess { 
            0% { background-color: rgba(16, 185, 129, 0.1); transform: scale(1); } 
            50% { background-color: rgba(16, 185, 129, 0.5); transform: scale(0.95); } 
            100% { background-color: rgba(30, 41, 59, 1); transform: scale(1); } 
        }
        
        .animate-in { animation-duration: 0.3s; animation-fill-mode: both; }
        .fade-in { animation-name: fadeIn; }
        .slide-up { animation-name: slideUp; }
        .slide-in-from-top-5 { animation-name: slideInFromTop; }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .flash-click { animation: flashSuccess 0.2s ease-out; }
        
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-slate-950 text-slate-200 antialiased selection:bg-emerald-500/30">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef, useCallback } = React;

        // --- FIREBASE SETUP ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        
        let app, auth, db;
        if (Object.keys(firebaseConfig).length > 0 && typeof firebase !== 'undefined') {
            if (!firebase.apps.length) {
                app = firebase.initializeApp(firebaseConfig);
            } else {
                app = firebase.app();
            }
            auth = firebase.auth();
            db = firebase.firestore();
        }

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'tipkeeper-default';

        const getCollectionRef = (collectionName) => {
            if (!db) return null;
            return db.collection('artifacts').doc(appId).collection('public').doc('data').collection(collectionName);
        };
        
        const getConfigRef = () => {
            if (!db) return null;
            return db.collection('artifacts').doc(appId).collection('public').doc('data').collection('config').doc('main');
        };

        // --- ICONOS ---
        const Icon = ({ d, size = 24, className = "", ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>
                {Array.isArray(d) ? d.map((path, i) => <path key={i} d={path} />) : <path d={d} />}
                {props.children}
            </svg>
        );

        const Beer = (p) => <Icon {...p} d={["M17 11h1a3 3 0 0 1 0 6h-1", "M9 12v6", "M13 12v6", "M14 7.5c-1 0-1.44.5-3 .5s-2-.5-3-.5-1.72.5-2.5.5a2.5 2.5 0 0 1 0-5c.78 0 1.57.5 2.5.5S9.44 2 11 2s2 1.5 2.5 2 1.72-.5 2.5-.5a2.5 2.5 0 0 1 0 5c-.78 0-1.5-.5-2.5-.5Z", "M5 8v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V8"]} />;
        const DollarSign = (p) => <Icon {...p} d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6" />;
        const LayoutDashboard = (p) => <Icon {...p}><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></Icon>;
        const ClipboardList = (p) => <Icon {...p}><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></Icon>;
        const Plus = (p) => <Icon {...p} d="M5 12h14M12 5v14" />;
        const Minus = (p) => <Icon {...p} d="M5 12h14" />;
        const Trash2 = (p) => <Icon {...p} d={["M3 6h18", "M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6", "M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2", "M10 11v6", "M14 11v6"]} />;
        const ShoppingCart = (p) => <Icon {...p}><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/></Icon>;
        const X = (p) => <Icon {...p} d={["M18 6 6 18", "M6 6l12 12"]} />;
        const Save = (p) => <Icon {...p} d={["M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z", "M17 21v-8H7v8", "M7 3v5h8V3"]} />;
        const FileSpreadsheet = (p) => <Icon {...p}><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M8 13h2"/><path d="M14 13h2"/><path d="M8 17h2"/><path d="M14 17h2"/></Icon>;
        const TrendingUp = (p) => <Icon {...p} d={["m22 7-8.5 8.5-5-5L2 17.5", "M16 7h6v6"]} />;
        const CheckCircle2 = (p) => <Icon {...p}><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></Icon>;
        const LogOut = (p) => <Icon {...p} d={["M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4", "M16 17l5-5-5-5", "M21 12H9"]} />;
        const Lock = (p) => <Icon {...p}><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></Icon>;
        const Receipt = (p) => <Icon {...p} d={["M4 2v20l2-1 2 1 2-1 2 1 2-1 2 1 2-1 2 1V2l-2 1-2-1-2 1-2-1-2 1Z", "M16 8h-6", "M16 12h-6", "M16 16h-6"]} />;
        const AlertTriangle = (p) => <Icon {...p} d={["m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z", "M12 9v4", "M12 17h.01"]} />;
        const Archive = (p) => <Icon {...p}><rect width="20" height="5" x="2" y="3" rx="1"/><path d="M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8"/><path d="M10 12h4"/></Icon>;
        const Users = (p) => <Icon {...p} d={["M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2", "circle cx='9' cy='7' r='4'", "M22 21v-2a4 4 0 0 0-3-3.87", "M16 3.13a4 4 0 0 1 0 7.75"]}><circle cx="9" cy="7" r="4"/></Icon>;
        const UserPlus = (p) => <Icon {...p} d={["M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2", "M19 8v6", "M22 11h-6"]}><circle cx="9" cy="7" r="4"/></Icon>;
        const Shield = (p) => <Icon {...p} d="M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z" />;
        const User = (p) => <Icon {...p} d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"><circle cx="12" cy="7" r="4"/></Icon>;
        const InfinityIcon = (p) => <Icon {...p} d="M12 12c-2-2.67-4-4-6-4a4 4 0 1 0 0 8c2 0 4-1.33 6-4Zm0 0c2 2.67 4 4 6 4a4 4 0 0 0 0-8c-2 0-4 1.33-6 4Z" />;
        const BoxSelect = (p) => <Icon {...p} d={["M5 3a2 2 0 0 0-2 2", "M19 3a2 2 0 0 1 2 2", "M21 19a2 2 0 0 1-2 2", "M5 21a2 2 0 0 1-2-2", "M9 3h1", "M9 21h1", "M14 3h1", "M14 21h1", "M3 9v1", "M21 9v1", "M3 14v1", "M21 14v1"]} />;
        const Pencil = (p) => <Icon {...p} d={["M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z", "M15 5l4 4"]} />;
        const Clock = (p) => <Icon {...p}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></Icon>;
        const Activity = (p) => <Icon {...p} d="M22 12h-4l-3 9L9 3l-3 9H2" />;
        const Upload = (p) => <Icon {...p} d={["M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4", "M17 8l-5-5-5 5", "M12 3v12"]} />;
        const Palette = (p) => <Icon {...p} d={["M13.5 17.5h-9a4.5 4.5 0 0 1 0-9h9a4.5 4.5 0 0 1 0 9Z", "M13.5 17.5v-9"]}><circle cx="8" cy="13" r="1.5"/><circle cx="13" cy="13" r="1.5"/><circle cx="18" cy="13" r="1.5"/></Icon>;
        const Check = (p) => <Icon {...p} d="M20 6 9 17l-5-5" />;
        const Menu = (p) => <Icon {...p} d={["M4 6h16", "M4 12h16", "M4 18h16"]} />;
        const Split = (p) => <Icon {...p} d={["M16 3h5v5", "M8 3H3v5", "M12 22v-8", "M6.3 20.3a9 9 0 0 1 0-12.6", "M17.7 20.3a9 9 0 0 0 0-12.6"]} />;
        const RotateCcw = (p) => <Icon {...p} d={["M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8", "M3 3v5h5", "M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16", "M16 21h5v-5"]} />;
        const ChevronUp = (p) => <Icon {...p} d="m18 15-6-6-6 6"/>;
        const ChevronDown = (p) => <Icon {...p} d="m6 9 6 6 6-6"/>;
        const Trophy = (p) => <Icon {...p} d={["M6 9H4.5a2.5 2.5 0 0 1 0-5H6", "M18 9h1.5a2.5 2.5 0 0 0 0-5H18", "M4 22h16", "M2.5 17l10.6 6 10.6-6", "M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6Z"]}><path d="M12 2v3"/><path d="M12 15v7"/></Icon>;
        const Flame = (p) => <Icon {...p} d={["M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.148-.224-4.011 1.75-5.5-1 3.25 2.146 2.318 2.445 5.803.098 1.135.31 2.196 1.159 3.197A2.5 2.5 0 1 0 15 10c0-1.5-1.5-3-3.5-3-1.637-.606-1.904-2.122-1.5-4 1.605.832 3.228 1.677 3.5 4.5a4.5 4.5 0 0 1 6.814 2.693A5.993 5.993 0 0 0 17 19c0 3.268 2.604 6.056 5.5 7.5 0-2.727-1.446-4.413-2.18-6.032.593.643 1.085 1.326 1.18 2.032 3-2.5 2.5-6.5 2.5-6.5-1.5 2-4 2.5-5 2.5-2.206 0-4-1.794-4-4 0-1.618 1.535-2.871 3.138-3.293A3.99 3.99 0 0 1 18 10c0 2.209 1.791 4 4 4 .384 0 .757-.066 1.108-.185A3.998 3.998 0 0 0 21.746 18H8.5Z"]} />;
        const Home = (p) => <Icon {...p} d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"><polyline points="9 22 9 12 15 12 15 22"/></Icon>;
        const RefreshCcw = (p) => <Icon {...p} d={["M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8", "M3 3v5h5", "M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16", "M16 21h5v-5"]} />;
        const Search = (p) => <Icon {...p} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />;
        const FileText = (p) => <Icon {...p} d={["M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z", "M14 2v6h6", "M16 13H8", "M16 17H8", "M10 9H8"]} />;
        const Heart = (p) => <Icon {...p} d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z" />;

        // --- CONFIGURACI√ìN ---
        const INITIAL_USERS = {
            '0412': { name: 'Administrador', role: 'admin', color: 'text-emerald-400' },
            '0013': { name: 'Bartender', role: 'user', color: 'text-amber-400' },
            '0000': { name: 'Caja', role: 'user', color: 'text-blue-400' }
        };
        const APP_VERSION = "v.1.0.1 (Cloud)"; 

        const THEMES = {
            astro: { id: 'astro', name: 'theAstroBruh', colors: { text: 'text-indigo-400', bg: 'bg-indigo-500', bgHover: 'hover:bg-indigo-600', border: 'border-indigo-500', ring: 'focus:ring-indigo-500', lightBg: 'bg-indigo-500/20', badge: 'bg-indigo-500/10 text-indigo-400', selection: 'selection:bg-indigo-500/30' } },
            og: { id: 'og', name: 'Kush', colors: { text: 'text-emerald-400', bg: 'bg-emerald-500', bgHover: 'hover:bg-emerald-600', border: 'border-emerald-500', ring: 'focus:ring-emerald-500', lightBg: 'bg-emerald-500/20', badge: 'bg-emerald-500/10 text-emerald-400', selection: 'selection:bg-emerald-500/30' } },
            amethyst: { id: 'amethyst', name: 'SaturnUnU', colors: { text: 'text-purple-400', bg: 'bg-purple-500', bgHover: 'hover:bg-purple-600', border: 'border-purple-500', ring: 'focus:ring-purple-500', lightBg: 'bg-purple-500/20', badge: 'bg-purple-500/10 text-purple-400', selection: 'selection:bg-purple-500/30' } },
            crimson: { id: 'crimson', name: 'Crimson', colors: { text: 'text-rose-400', bg: 'bg-rose-500', bgHover: 'hover:bg-rose-600', border: 'border-rose-500', ring: 'focus:ring-rose-500', lightBg: 'bg-rose-500/20', badge: 'bg-rose-500/10 text-rose-400', selection: 'selection:bg-rose-500/30' } },
            sunset: { id: 'sunset', name: 'Arturos', colors: { text: 'text-orange-400', bg: 'bg-orange-500', bgHover: 'hover:bg-orange-600', border: 'border-orange-500', ring: 'focus:ring-orange-500', lightBg: 'bg-orange-500/20', badge: 'bg-orange-500/10 text-orange-400', selection: 'selection:bg-orange-500/30' } },
            ocean: { id: 'ocean', name: 'Cryo', colors: { text: 'text-cyan-400', bg: 'bg-cyan-500', bgHover: 'hover:bg-cyan-600', border: 'border-cyan-500', ring: 'focus:ring-cyan-500', lightBg: 'bg-cyan-500/20', badge: 'bg-cyan-500/10 text-cyan-400', selection: 'selection:bg-cyan-500/30' } }
        };

        const CATEGORY_STYLES = {
            'Mocktails': { color: 'text-teal-400', border: 'border-teal-500/50', bg: 'bg-teal-500/10', emoji: 'ü•§' },
            'Cocteles': { color: 'text-pink-400', border: 'border-pink-500/50', bg: 'bg-pink-500/10', emoji: 'üçπ' },
            'Vadas Specials': { color: 'text-violet-400', border: 'border-violet-500/50', bg: 'bg-violet-500/10', emoji: '‚ú®' },
            'Sparks': { color: 'text-yellow-400', border: 'border-yellow-500/50', bg: 'bg-yellow-500/10', emoji: 'ü•Ç' },
            'Whisky': { color: 'text-orange-400', border: 'border-orange-500/50', bg: 'bg-orange-500/10', emoji: 'ü•É' },
            'Ron': { color: 'text-red-400', border: 'border-red-500/50', bg: 'bg-red-500/10', emoji: 'üè¥‚Äç‚ò†Ô∏è' },
            'Cervezas': { color: 'text-amber-400', border: 'border-amber-500/50', bg: 'bg-amber-500/10', emoji: 'üç∫' },
            'Comida': { color: 'text-lime-400', border: 'border-lime-500/50', bg: 'bg-lime-500/10', emoji: 'üçî' },
            'Licores': { color: 'text-slate-300', border: 'border-slate-500/50', bg: 'bg-slate-500/10', emoji: 'üçæ' },
            'Otros': { color: 'text-gray-400', border: 'border-gray-500/50', bg: 'bg-gray-500/10', emoji: '‚öôÔ∏è' },
            'default': { color: 'text-slate-200', border: 'border-slate-700', bg: 'bg-slate-800', emoji: 'üì¶' }
        };

        const INITIAL_MENU = [
            { id: 101, name: 'Mojito Virgen', price: 3.0, stock: 0, category: 'Mocktails', trackStock: false },
            { id: 102, name: 'Mr. Miyagi', price: 4.0, stock: 0, category: 'Mocktails', trackStock: false },
            { id: 103, name: 'Peace Mind Tea', price: 4.0, stock: 0, category: 'Mocktails', trackStock: false },
            { id: 104, name: 'Shirley Temple', price: 4.0, stock: 0, category: 'Mocktails', trackStock: false },
            { id: 105, name: 'Velvet', price: 5.0, stock: 0, category: 'Mocktails', trackStock: false },
            { id: 106, name: 'Barcelona', price: 5.0, stock: 0, category: 'Mocktails', trackStock: false },
            { id: 107, name: 'Iced Sunrise', price: 5.0, stock: 0, category: 'Mocktails', trackStock: false },
            { id: 108, name: 'Pi√±a Colada', price: 5.0, stock: 0, category: 'Mocktails', trackStock: false },
            { id: 109, name: 'San Francisco', price: 5.0, stock: 0, category: 'Mocktails', trackStock: false },
            { id: 201, name: 'Mojito Parchita', price: 5.0, stock: 0, category: 'Cocteles', trackStock: false },
            { id: 202, name: 'Mojito Fresa', price: 5.0, stock: 0, category: 'Cocteles', trackStock: false },
            { id: 203, name: 'Mojito Tradicional', price: 5.0, stock: 0, category: 'Cocteles', trackStock: false },
            { id: 204, name: 'Cuba Libre', price: 5.0, stock: 0, category: 'Cocteles', trackStock: false },
            { id: 205, name: 'Kamikase', price: 6.0, stock: 0, category: 'Cocteles', trackStock: false },
            { id: 206, name: 'Moscow Mule', price: 6.0, stock: 0, category: 'Cocteles', trackStock: false },
            { id: 207, name: 'Gin Tonic', price: 6.0, stock: 0, category: 'Cocteles', trackStock: false },
            { id: 208, name: 'Margarita', price: 7.0, stock: 0, category: 'Cocteles', trackStock: false },
            { id: 209, name: 'Paloma', price: 7.0, stock: 0, category: 'Cocteles', trackStock: false },
            { id: 210, name: 'Tinto de Verano', price: 7.0, stock: 0, category: 'Cocteles', trackStock: false },
            { id: 301, name: 'Sinatra', price: 7.0, stock: 0, category: 'Vadas Specials', trackStock: false },
            { id: 302, name: 'Lady Gaga', price: 7.0, stock: 0, category: 'Vadas Specials', trackStock: false },
            { id: 303, name: 'Elvis', price: 7.0, stock: 0, category: 'Vadas Specials', trackStock: false },
            { id: 304, name: 'Madonna', price: 7.0, stock: 0, category: 'Vadas Specials', trackStock: false },
            { id: 305, name: 'Britney', price: 6.0, stock: 0, category: 'Vadas Specials', trackStock: false },
            { id: 306, name: 'Xtina', price: 6.0, stock: 0, category: 'Vadas Specials', trackStock: false },
            { id: 307, name: 'Beatles', price: 7.0, stock: 0, category: 'Vadas Specials', trackStock: false },
            { id: 308, name: 'AC/DC', price: 8.0, stock: 0, category: 'Vadas Specials', trackStock: false },
            { id: 309, name: 'Thriller', price: 7.0, stock: 0, category: 'Vadas Specials', trackStock: false },
            { id: 310, name: 'Bob Marley', price: 6.0, stock: 0, category: 'Vadas Specials', trackStock: false },
            { id: 401, name: 'Mimosa', price: 8.0, stock: 0, category: 'Sparks', trackStock: false },
            { id: 402, name: 'Aperol Spritz', price: 8.0, stock: 0, category: 'Sparks', trackStock: false },
            { id: 403, name: 'Vadaspark', price: 10.0, stock: 0, category: 'Sparks', trackStock: false },
            { id: 404, name: 'Charles Du Lac (Copa)', price: 6.0, stock: 0, category: 'Sparks', trackStock: false },
            { id: 405, name: 'Charles Du Lac (Bot)', price: 30.0, stock: 10, category: 'Sparks', trackStock: true },
            { id: 406, name: 'Louis Perdrier (Copa)', price: 8.0, stock: 0, category: 'Sparks', trackStock: false },
            { id: 407, name: 'Louis Perdrier (Bot)', price: 40.0, stock: 10, category: 'Sparks', trackStock: true },
            { id: 408, name: 'Caceres (Copa)', price: 9.0, stock: 0, category: 'Sparks', trackStock: false },
            { id: 409, name: 'Caceres (Bot)', price: 45.0, stock: 10, category: 'Sparks', trackStock: true },
            { id: 410, name: 'Mionetto (Copa)', price: 10.0, stock: 0, category: 'Sparks', trackStock: false },
            { id: 411, name: 'Mionetto (Bot)', price: 50.0, stock: 10, category: 'Sparks', trackStock: true },
            { id: 501, name: 'Buchanans 12 (Trago)', price: 8.0, stock: 0, category: 'Whisky', trackStock: false },
            { id: 502, name: 'Buchanans 12 (Bot)', price: 80.0, stock: 5, category: 'Whisky', trackStock: true },
            { id: 503, name: 'Old Parr 12 (Trago)', price: 7.0, stock: 0, category: 'Whisky', trackStock: false },
            { id: 504, name: 'Old Parr 12 (Bot)', price: 70.0, stock: 5, category: 'Whisky', trackStock: true },
            { id: 505, name: 'Grants 12 (Trago)', price: 6.0, stock: 0, category: 'Whisky', trackStock: false },
            { id: 506, name: 'Grants 12 (Bot)', price: 60.0, stock: 5, category: 'Whisky', trackStock: true },
            { id: 601, name: 'Santa Teresa 1796', price: 60.0, stock: 5, category: 'Ron', trackStock: true },
            { id: 602, name: 'Carupano Reserva Exc', price: 40.0, stock: 5, category: 'Ron', trackStock: true },
            { id: 603, name: 'Carupano Reserva Esp', price: 30.0, stock: 5, category: 'Ron', trackStock: true },
            { id: 604, name: 'Barrica 120', price: 120.0, stock: 2, category: 'Ron', trackStock: true },
            { id: 901, name: 'Otros', price: 1.0, stock: 0, category: 'Otros', trackStock: false },
        ];

        // --- COMPONENTES BASE ---
        const Card = ({ children, className = "" }) => <div className={`bg-slate-800 border border-slate-700 rounded-xl shadow-sm ${className}`}>{children}</div>;
        
        const Button = ({ children, onClick, variant = "primary", className = "", disabled = false, title = "", themeColors }) => {
            const variants = {
                primary: `${themeColors?.bg || 'bg-emerald-500'} ${themeColors?.bgHover || 'hover:bg-emerald-600'} text-white`,
                secondary: "bg-slate-700 hover:bg-slate-600 text-slate-200",
                danger: "bg-red-500 hover:bg-red-600 text-white",
                warning: "bg-amber-500 hover:bg-amber-600 text-slate-900",
                outline: "border border-slate-600 text-slate-300 hover:bg-slate-800",
                ghost: "hover:bg-slate-800 text-slate-400 hover:text-white"
            };
            return <button onClick={onClick} disabled={disabled} title={title} className={`px-4 py-2 rounded-lg font-medium transition-all active:scale-95 flex items-center justify-center gap-2 ${variants[variant]} ${className} ${disabled ? 'opacity-50 cursor-not-allowed grayscale' : ''}`}>{children}</button>;
        };

        const Input = ({ label, type = "text", value, onChange, placeholder, className = "", maxLength, disabled = false, themeColors }) => (
            <div className={`flex flex-col gap-1 ${className}`}>{label && <label className="text-xs text-slate-400 uppercase font-bold tracking-wider">{label}</label>}<input type={type} value={value} onChange={onChange} placeholder={placeholder} maxLength={maxLength} disabled={disabled} className={`bg-slate-900 border border-slate-700 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 ${themeColors?.ring || 'focus:ring-emerald-500'} transition-all ${disabled ? 'opacity-50 cursor-not-allowed' : ''}`}/></div>
        );

        const Select = ({ label, value, onChange, options, className = "", themeColors }) => (
            <div className={`flex flex-col gap-1 ${className}`}>{label && <label className="text-xs text-slate-400 uppercase font-bold tracking-wider">{label}</label>}<select value={value} onChange={onChange} className={`bg-slate-900 border border-slate-700 text-white rounded-lg px-3 py-2 focus:outline-none focus:ring-2 ${themeColors?.ring || 'focus:ring-emerald-500'} transition-all appearance-none`}>{options.map(opt => <option key={opt.value} value={opt.value}>{opt.label}</option>)}</select></div>
        );

        // --- CONTENIDO DEL CARRITO (REUTILIZABLE) ---
        const CartContent = ({ cart, updateQty, theme, cartTotalUSD, cartTotalVES, processSale, clearCart, onSplitPayment }) => (
            <div className="flex flex-col h-full">
                <div className="flex-1 overflow-y-auto space-y-3 mb-4 pr-2">
                    {cart.length === 0 ? (
                        <div className="text-center text-slate-500 py-10 italic flex flex-col items-center">
                            <ShoppingCart size={48} className="text-slate-700 mb-2 opacity-50" />
                            <span>Carrito vac√≠o</span>
                        </div>
                    ) : (
                        cart.map(item => (
                            <div key={item.id} className="flex justify-between items-center bg-slate-900 p-3 rounded-lg">
                                <div className="flex-1">
                                    <div className="text-white font-medium text-sm">{item.name}</div>
                                    <div className="text-slate-400 text-xs">${item.price} x {item.qty}</div>
                                </div>
                                <div className="flex items-center gap-2">
                                    <button onClick={() => updateQty(item.id, -1)} className="p-1 hover:text-red-400 text-slate-500"><Minus size={16}/></button>
                                    <span className="text-white font-mono w-4 text-center">{item.qty}</span>
                                    <button onClick={() => updateQty(item.id, 1)} className={`p-1 hover:${theme.text} text-slate-500`}><Plus size={16}/></button>
                                </div>
                            </div>
                        ))
                    )}
                </div>

                <div className="space-y-3 bg-slate-900 p-4 rounded-lg border border-slate-700">
                    <div className="flex justify-between text-slate-400 text-sm"><span>Total USD</span><span>${cartTotalUSD.toFixed(2)}</span></div>
                    <div className={`flex justify-between ${theme.text} font-bold text-xl border-t border-slate-700 pt-2`}><span>Total Bs.</span><span>{cartTotalVES.toLocaleString('es-VE', { minimumFractionDigits: 2 })}</span></div>
                    
                    <div className="grid grid-cols-2 gap-2 pt-2">
                        <Button onClick={() => processSale('Efectivo')} className="text-xs" themeColors={theme}>Efectivo</Button>
                        <Button onClick={() => processSale('Pago M√≥vil')} className="text-xs" variant="secondary" themeColors={theme}>Pago M√≥vil</Button>
                        <Button onClick={() => processSale('Tarjeta')} className="text-xs" variant="secondary" themeColors={theme}>Punto</Button>
                        <Button onClick={onSplitPayment} className="text-xs" variant="outline" themeColors={theme}>Mixto</Button>
                    </div>
                    {cart.length > 0 && (
                        <button onClick={clearCart} className="w-full text-xs text-red-400 hover:text-red-300 pt-2 flex items-center justify-center gap-1">
                            <Trash2 size={14} /> Cancelar Orden
                        </button>
                    )}
                </div>
            </div>
        );

        // --- COMPONENTES VISTAS Y MODALES ---
        const useDailyStats = (sales) => {
            return useMemo(() => {
                const today = new Date().toISOString().split('T')[0];
                const todaysSales = sales.filter(s => s.date.startsWith(today));
                
                if (todaysSales.length === 0) return null;

                const itemCounts = {};
                const userCounts = {};

                todaysSales.forEach(sale => {
                    userCounts[sale.user] = (userCounts[sale.user] || 0) + 1;
                    sale.items.forEach(item => {
                        itemCounts[item.name] = (itemCounts[item.name] || 0) + item.qty;
                    });
                });

                let topItem = { name: '-', count: 0 };
                Object.entries(itemCounts).forEach(([name, count]) => {
                    if (count > topItem.count) topItem = { name, count };
                });

                let topUser = { name: '-', count: 0 };
                Object.entries(userCounts).forEach(([name, count]) => {
                    if (count > topUser.count) topUser = { name, count };
                });

                return { topItem, topUser };
            }, [sales]);
        };

        const DashboardView = ({ sales, theme }) => {
            const recentActivity = sales.slice(0, 4);
            const dailyStats = useDailyStats(sales);
            
            // Calculate Daily Totals
            const today = new Date().toISOString().split('T')[0];
            const todaysSales = sales.filter(s => s.date.startsWith(today));
            const dailyTotalUSD = todaysSales.reduce((acc, s) => acc + s.totalUSD, 0);
            const dailyTotalVES = todaysSales.reduce((acc, s) => acc + s.totalVES, 0);

            return (
                <div className="pb-24 pt-4 px-4 max-w-5xl mx-auto space-y-6 animate-fade-in">
                    {/* Main Stats Cards */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <Card className="p-6 bg-gradient-to-br from-slate-800 to-slate-900 border-slate-700 relative overflow-hidden">
                            <div className={`absolute top-0 right-0 p-4 opacity-10 ${theme.text}`}><DollarSign size={64}/></div>
                            <p className="text-slate-400 text-xs uppercase font-bold tracking-wider">Ventas de Hoy</p>
                            <h2 className="text-4xl font-bold text-white mt-2">${dailyTotalUSD.toFixed(2)}</h2>
                            <p className="text-slate-500 text-sm font-mono mt-1">Bs. {dailyTotalVES.toLocaleString('es-VE', { minimumFractionDigits: 2 })}</p>
                        </Card>
                        
                        <div className="grid grid-cols-2 gap-4">
                             <div className="bg-slate-800 border border-slate-700 p-4 rounded-xl flex flex-col items-center text-center justify-center">
                                <div className="bg-pink-500/10 p-2 rounded-full text-pink-400 mb-2"><Heart size={20}/></div>
                                <p className="text-[10px] text-slate-500 uppercase font-bold tracking-wider">Favorito</p>
                                <p className="text-sm font-bold text-white line-clamp-1">{dailyStats ? dailyStats.topItem.name : '-'}</p>
                                <span className="text-[10px] text-slate-400">{dailyStats ? dailyStats.topItem.count : 0} vendidos</span>
                            </div>
                            <div className="bg-slate-800 border border-slate-700 p-4 rounded-xl flex flex-col items-center text-center justify-center">
                                <div className={`bg-indigo-500/10 p-2 rounded-full ${theme.text} mb-2`}><Trophy size={20}/></div>
                                <p className="text-[10px] text-slate-500 uppercase font-bold tracking-wider">MVP</p>
                                <p className="text-sm font-bold text-white line-clamp-1">{dailyStats ? dailyStats.topUser.name : '-'}</p>
                                <span className="text-[10px] text-slate-400">{dailyStats ? dailyStats.topUser.count : 0} ventas</span>
                            </div>
                        </div>
                    </div>

                    {/* Recent Activity Feed */}
                    <div>
                        <div className="flex items-center justify-between mb-4"><h3 className="font-bold text-white text-lg flex items-center gap-2"><Activity size={20} className={theme.text} /> Actividad Reciente</h3></div>
                        <div className="space-y-3">
                            {recentActivity.length === 0 ? (
                                <div className="text-center py-12 text-slate-600 italic bg-slate-900/50 rounded-xl border border-slate-800/50">
                                    <p>Sin actividad registrada hoy.</p>
                                </div>
                            ) : (
                                recentActivity.map(s => (
                                    <div key={s.id} className="bg-slate-900 border border-slate-800 p-4 rounded-xl flex justify-between items-center hover:border-slate-700 transition-colors">
                                        <div className="flex-1 min-w-0 pr-4">
                                            <div className="flex items-center gap-2 mb-1">
                                                <span className={`text-sm font-bold ${theme.text}`}>${s.totalUSD.toFixed(2)}</span>
                                                <span className="text-[10px] text-slate-400 bg-slate-800 px-2 py-0.5 rounded border border-slate-700 uppercase tracking-wider">{s.method}</span>
                                            </div>
                                            <p className="text-xs text-slate-300 truncate">{s.items.map(i => `${i.qty} ${i.name}`).join(', ')}</p>
                                        </div>
                                        <div className="text-right pl-4 border-l border-slate-800">
                                            <div className="text-xs text-slate-500 font-mono mb-1">{new Date(s.date).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
                                            <div className="text-[10px] text-white font-bold uppercase bg-slate-800 px-2 py-1 rounded-full inline-block">{s.user}</div>
                                        </div>
                                    </div>
                                ))
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const InventoryView = ({ menu, theme, requestConfirm, setNotification }) => {
            const [newItem, setNewItem] = useState({ name: '', price: '', stock: '', category: 'Cervezas', trackStock: true });
            const [editingId, setEditingId] = useState(null);
            const fileInputRef = useRef(null);
            const txtInputRef = useRef(null);
            const [sortConfig, setSortConfig] = useState({ key: 'name', direction: 'asc' });
            const [searchTerm, setSearchTerm] = useState('');
            
            // State for bulk preview
            const [bulkPreview, setBulkPreview] = useState(null);

            const handleImportMenu = (event) => {
                const file = event.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedMenu = JSON.parse(e.target.result);
                        if (!Array.isArray(importedMenu)) throw new Error("El archivo debe ser una lista.");
                        
                        requestConfirm("Importar", `¬øImportar ${importedMenu.length} productos? Esto sobrescribir√° el men√∫ actual.`, async () => {
                            const batch = db.batch();
                            importedMenu.forEach(item => {
                                const docRef = getCollectionRef('menu').doc(String(item.id || Date.now() + Math.random()));
                                batch.set(docRef, { ...item, price: parseFloat(item.price), stock: item.stock || 0, trackStock: item.trackStock !== undefined ? item.trackStock : true });
                            });
                            await batch.commit();
                            setNotification({ title: "Importaci√≥n Exitosa", message: "Men√∫ actualizado en la nube." });
                        });
                    } catch (error) { console.error(error); setNotification({ title: "Error", message: "JSON inv√°lido." }); }
                };
                reader.readAsText(file); event.target.value = null;
            };

            const handleTxtUpload = (event) => {
                const file = event.target.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const text = e.target.result;
                    const lines = text.split('\n').filter(l => l.trim().length > 0);
                    
                    const matches = [];
                    const unparsed = [];
                    
                    lines.forEach(line => {
                        // Simple logic: find last number in line
                        const match = line.match(/(.*?)(\d+)\s*$/);
                        if (match) {
                            const rawName = match[1].trim().replace(/[:\-\s]+$/, '');
                            const qty = parseInt(match[2]);
                            
                            // Find best match in menu
                            const menuItem = menu.find(m => m.name.toLowerCase() === rawName.toLowerCase() || m.name.toLowerCase().includes(rawName.toLowerCase()) || rawName.toLowerCase().includes(m.name.toLowerCase()));
                            
                            if (menuItem) {
                                matches.push({ item: menuItem, newQty: qty, type: 'match' });
                            } else {
                                unparsed.push({ line, reason: 'Producto no encontrado' });
                            }
                        } else {
                            unparsed.push({ line, reason: 'Formato inv√°lido' });
                        }
                    });
                    setBulkPreview({ matches, unparsed, mode: 'set' }); // Default mode: SET (Audit)
                };
                reader.readAsText(file); event.target.value = null;
            };

            const confirmBulkUpdate = async () => {
                if (!bulkPreview) return;
                const batch = db.batch();
                let updateCount = 0;
                
                bulkPreview.matches.forEach(({ item, newQty }) => {
                    const finalStock = bulkPreview.mode === 'add' ? (item.stock + newQty) : newQty;
                    const docRef = getCollectionRef('menu').doc(String(item.id));
                    batch.update(docRef, { stock: finalStock });
                    updateCount++;
                });

                try {
                    await batch.commit();
                    setNotification({ title: "Stock Actualizado", message: `${updateCount} productos modificados.` });
                    setBulkPreview(null);
                } catch (e) {
                    console.error(e);
                    setNotification({ title: "Error", message: "Fallo al actualizar stock." });
                }
            };
            
            const handleSaveItem = async () => {
                if (!newItem.name || !newItem.price) return;
                try {
                    const itemData = { ...newItem, price: parseFloat(newItem.price), stock: newItem.trackStock ? (parseInt(newItem.stock) || 0) : 0 };
                    if (editingId) {
                        await getCollectionRef('menu').doc(String(editingId)).update(itemData);
                        setEditingId(null); 
                        setNotification({ title: "Actualizado", message: "Producto modificado." }); 
                    } else { 
                        const newId = Date.now();
                        await getCollectionRef('menu').doc(String(newId)).set({ ...itemData, id: newId });
                        setNotification({ title: "Agregado", message: "Nuevo producto." }); 
                    }
                    setNewItem({ name: '', price: '', stock: '', category: 'Cervezas', trackStock: true });
                } catch(e) { console.error(e); setNotification({title:"Error", message: "Error al guardar"}); }
            };

            const handleEdit = (item) => { setEditingId(item.id); setNewItem({ name: item.name, price: item.price, stock: item.stock, category: item.category, trackStock: item.trackStock }); window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }); };
            
            const handleDelete = (id) => { 
                requestConfirm("Borrar Producto", "¬øBorrar producto permanentemente?", async () => {
                    await getCollectionRef('menu').doc(String(id)).delete();
                });
            };
            
            const toggleStockTracking = async (item) => {
                await getCollectionRef('menu').doc(String(item.id)).update({ trackStock: !item.trackStock });
            };

            const sortedMenu = useMemo(() => {
                let items = [...menu];
                if (searchTerm) items = items.filter(i => i.name.toLowerCase().includes(searchTerm.toLowerCase()));
                if (sortConfig.key) {
                    items.sort((a, b) => {
                        let valA = a[sortConfig.key];
                        let valB = b[sortConfig.key];
                        if (typeof valA === 'string') valA = valA.toLowerCase();
                        if (typeof valB === 'string') valB = valB.toLowerCase();
                        if (valA < valB) return sortConfig.direction === 'asc' ? -1 : 1;
                        if (valA > valB) return sortConfig.direction === 'asc' ? 1 : -1;
                        return 0;
                    });
                }
                return items;
            }, [menu, sortConfig, searchTerm]);

            const requestSort = (key) => {
                let direction = 'asc';
                if (sortConfig.key === key && sortConfig.direction === 'asc') {
                    direction = 'desc';
                }
                setSortConfig({ key, direction });
            };

            const SortIcon = ({ column }) => {
                if (sortConfig.key !== column) return <div className="w-4 h-4 opacity-20"><ChevronDown size={16}/></div>;
                return sortConfig.direction === 'asc' ? <ChevronUp size={16} className={theme.text}/> : <ChevronDown size={16} className={theme.text}/>;
            };

            return (
                <div className="pb-24 pt-4 px-4 max-w-5xl mx-auto space-y-6">
                    <input type="file" ref={fileInputRef} accept=".json" onChange={handleImportMenu} className="hidden" />
                    <input type="file" ref={txtInputRef} accept=".txt" onChange={handleTxtUpload} className="hidden" />
                    
                    {/* Search Bar */}
                    <div className="bg-slate-800 p-4 rounded-xl border border-slate-700">
                        <div className="relative">
                            <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <Search size={18} className="text-slate-400" />
                            </div>
                            <input 
                                type="text" 
                                value={searchTerm}
                                onChange={(e) => setSearchTerm(e.target.value)}
                                className="bg-slate-900 border border-slate-700 text-white rounded-lg pl-10 pr-4 py-2 w-full focus:outline-none focus:ring-2 focus:ring-emerald-500 transition-all"
                                placeholder="Buscar producto..." 
                            />
                        </div>
                    </div>

                    <div className="bg-slate-800 rounded-xl overflow-hidden border border-slate-700 overflow-x-auto">
                        <table className="w-full text-left text-sm text-slate-300 min-w-[600px]">
                            <thead className="bg-slate-900 text-slate-400 uppercase text-xs">
                                <tr>
                                    <th onClick={() => requestSort('name')} className="p-4 cursor-pointer hover:text-white transition-colors select-none"><div className="flex items-center gap-1">Producto <SortIcon column="name"/></div></th>
                                    <th onClick={() => requestSort('category')} className="p-4 cursor-pointer hover:text-white transition-colors select-none"><div className="flex items-center gap-1">Cat. <SortIcon column="category"/></div></th>
                                    <th onClick={() => requestSort('price')} className="p-4 text-right cursor-pointer hover:text-white transition-colors select-none"><div className="flex items-center justify-end gap-1">$$ <SortIcon column="price"/></div></th>
                                    <th onClick={() => requestSort('stock')} className="p-4 text-center cursor-pointer hover:text-white transition-colors select-none"><div className="flex items-center justify-center gap-1">Stock <SortIcon column="stock"/></div></th>
                                    <th className="p-4 text-center">Acci√≥n</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-700">
                                {sortedMenu.map(item => (
                                    <tr key={item.id} className={`hover:bg-slate-700/50 transition-colors ${editingId === item.id ? 'bg-slate-700/30' : ''}`}>
                                        <td className="p-4 font-medium text-white">{item.name}</td><td className="p-4">{item.category}</td><td className={`p-4 text-right font-mono ${theme.text}`}>${item.price.toFixed(2)}</td>
                                        <td className="p-4 text-center">{item.trackStock ? (<span className={`px-2 py-1 rounded text-xs font-mono ${item.stock < 10 ? 'bg-red-500/20 text-red-400' : 'bg-slate-700 text-white'}`}>{item.stock}</span>) : <span className="text-slate-500 flex justify-center"><InfinityIcon size={18}/></span>}</td>
                                        <td className="p-4 text-center flex justify-center gap-2">
                                            <button onClick={() => handleEdit(item)} className="p-2 text-slate-500 hover:text-amber-400 hover:bg-amber-500/10 rounded-lg"><Pencil size={18} /></button>
                                            <button onClick={() => toggleStockTracking(item)} className={`p-2 rounded-lg ${item.trackStock ? `${theme.text} hover:${theme.lightBg}` : 'text-slate-500 hover:bg-slate-700'}`}>{item.trackStock ? <BoxSelect size={18} /> : <InfinityIcon size={18} />}</button>
                                            <button onClick={() => handleDelete(item.id)} className="p-2 text-slate-500 hover:text-red-400 hover:bg-red-500/10 rounded-lg"><Trash2 size={18} /></button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                         {/* Add/Edit Card */}
                        <Card className={`p-6 transition-all duration-300 ${editingId ? `${theme.border} ring-1 ${theme.ring.replace('focus:', '')}/50` : ''}`}>
                            <div className="flex justify-between items-center mb-4">
                                <div className="flex items-center gap-3"><h2 className="text-xl font-bold text-white flex items-center gap-2">{editingId ? <><Pencil size={20} className={theme.text}/> Editar</> : "Nuevo Producto"}</h2>{!editingId && <button onClick={() => fileInputRef.current.click()} className="text-xs bg-slate-700 hover:bg-slate-600 text-slate-300 px-3 py-1.5 rounded-lg flex items-center gap-2 border border-slate-600"><Upload size={14} /> Importar JSON</button>}</div>
                                {editingId && <button onClick={() => {setEditingId(null); setNewItem({ name: '', price: '', stock: '', category: 'Cervezas', trackStock: true })}} className="text-xs text-slate-400 hover:text-white flex items-center gap-1"><X size={14}/> Cancelar</button>}
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 items-end">
                                <div className="md:col-span-2"><Input themeColors={theme} label="Nombre" value={newItem.name} onChange={e => setNewItem({...newItem, name: e.target.value})} placeholder="Ej. Hamburguesa" /></div>
                                <Input themeColors={theme} label="Precio ($)" type="number" value={newItem.price} onChange={e => setNewItem({...newItem, price: e.target.value})} placeholder="0.00" />
                                <div className="flex flex-col gap-1"><label className="text-xs text-slate-400 uppercase font-bold tracking-wider">Tipo</label><button onClick={() => setNewItem({...newItem, trackStock: !newItem.trackStock})} className={`h-[42px] w-full rounded-lg border border-slate-700 flex items-center justify-center gap-2 transition-colors ${newItem.trackStock ? `bg-slate-800 ${theme.text}` : 'bg-slate-800 text-slate-400'}`}>{newItem.trackStock ? <ClipboardList size={18} /> : <InfinityIcon size={18} />}<span className="text-xs font-bold">{newItem.trackStock ? "Contable" : "Infinito"}</span></button></div>
                                <Input themeColors={theme} label="Stock" type="number" value={newItem.trackStock ? newItem.stock : ''} onChange={e => setNewItem({...newItem, stock: e.target.value})} placeholder={newItem.trackStock ? "0" : "‚àû"} disabled={!newItem.trackStock}/>
                                <Button themeColors={theme} onClick={handleSaveItem} className="w-full" variant={editingId ? "warning" : "primary"}>{editingId ? <><Save size={18} /> Guardar</> : <><Plus size={18} /> Agregar</>}</Button>
                            </div>
                        </Card>

                        {/* Bulk Stock Card */}
                        <Card className="p-6 flex flex-col justify-between">
                            <div>
                                <h2 className="text-xl font-bold text-white flex items-center gap-2 mb-2"><FileText size={20} className={theme.text}/> Carga Masiva</h2>
                                <p className="text-sm text-slate-400 mb-4">Sube un archivo .txt con tu inventario para actualizar el stock autom√°ticamente.</p>
                                <div className="bg-slate-900 rounded-lg p-3 border border-slate-700 mb-4">
                                    <p className="text-xs text-slate-500 uppercase font-bold mb-1">Formato ejemplo:</p>
                                    <code className="text-xs font-mono text-emerald-400 block">Heineken 24</code>
                                    <code className="text-xs font-mono text-emerald-400 block">Solera Verde: 10</code>
                                </div>
                            </div>
                            <Button onClick={() => txtInputRef.current.click()} themeColors={theme} variant="secondary" className="w-full border border-slate-600"><Upload size={18}/> Seleccionar Archivo</Button>
                        </Card>
                    </div>

                    {/* Bulk Preview Modal */}
                    {bulkPreview && (
                        <div className="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in">
                            <div className="bg-slate-800 rounded-2xl w-full max-w-lg border border-slate-700 shadow-2xl max-h-[80vh] flex flex-col">
                                <div className="p-4 border-b border-slate-700 flex justify-between items-center shrink-0">
                                    <h3 className="text-lg font-bold text-white">Confirmar Carga</h3>
                                    <button onClick={() => setBulkPreview(null)} className="text-slate-400 hover:text-white"><X size={20}/></button>
                                </div>
                                <div className="p-4 border-b border-slate-700 bg-slate-900/50 shrink-0">
                                    <div className="flex gap-2 mb-2">
                                        <button onClick={() => setBulkPreview({...bulkPreview, mode: 'set'})} className={`flex-1 py-2 rounded-lg text-xs font-bold transition-colors border ${bulkPreview.mode === 'set' ? `${theme.bg} text-white border-transparent` : 'bg-slate-800 text-slate-400 border-slate-700'}`}>REEMPLAZAR (Inventario)</button>
                                        <button onClick={() => setBulkPreview({...bulkPreview, mode: 'add'})} className={`flex-1 py-2 rounded-lg text-xs font-bold transition-colors border ${bulkPreview.mode === 'add' ? `${theme.bg} text-white border-transparent` : 'bg-slate-800 text-slate-400 border-slate-700'}`}>SUMAR (Compra)</button>
                                    </div>
                                    <p className="text-xs text-center text-slate-400">{bulkPreview.mode === 'set' ? "El stock actual ser√° reemplazado por el valor del archivo." : "El valor del archivo se sumar√° al stock actual."}</p>
                                </div>
                                <div className="flex-1 overflow-y-auto p-4 space-y-4">
                                    {bulkPreview.matches.length > 0 && (
                                        <div>
                                            <h4 className="text-xs font-bold text-emerald-400 uppercase mb-2">Coincidencias ({bulkPreview.matches.length})</h4>
                                            <div className="space-y-2">
                                                {bulkPreview.matches.map((m, i) => (
                                                    <div key={i} className="flex justify-between items-center text-sm bg-slate-900 p-2 rounded border border-slate-700">
                                                        <span className="text-slate-300">{m.item.name}</span>
                                                        <div className="flex items-center gap-2 font-mono text-xs">
                                                            <span className="text-slate-500">{m.item.stock}</span>
                                                            <span className="text-slate-600">‚Üí</span>
                                                            <span className="text-white font-bold">{bulkPreview.mode === 'add' ? m.item.stock + m.newQty : m.newQty}</span>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                    {bulkPreview.unparsed.length > 0 && (
                                        <div>
                                            <h4 className="text-xs font-bold text-red-400 uppercase mb-2">No Encontrados / Error ({bulkPreview.unparsed.length})</h4>
                                            <div className="space-y-2 opacity-70">
                                                {bulkPreview.unparsed.map((u, i) => (
                                                    <div key={i} className="flex justify-between items-center text-xs bg-red-900/10 p-2 rounded border border-red-900/20">
                                                        <span className="text-red-300 truncate pr-2">{u.line}</span>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>
                                <div className="p-4 border-t border-slate-700 shrink-0">
                                    <Button onClick={confirmBulkUpdate} themeColors={theme} className="w-full" disabled={bulkPreview.matches.length === 0}>Confirmar Actualizaci√≥n</Button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const UsersView = ({ users, currentUser, theme, setNotification, requestConfirm }) => {
            const [newUser, setNewUser] = useState({ pin: '', name: '', role: 'user' });
            
            const handleAddUser = async () => {
                if (!newUser.pin || newUser.pin.length !== 4 || !newUser.name) { setNotification({title: "Error", message: "Datos incompletos."}); return; }
                if (users[newUser.pin]) { setNotification({title: "Error", message: "PIN en uso."}); return; }
                
                const color = newUser.role === 'admin' ? theme.text : 'text-amber-400';
                const userToSave = { ...newUser, color };
                
                try {
                    await getCollectionRef('users').doc(newUser.pin).set(userToSave);
                    setNewUser({ pin: '', name: '', role: 'user' }); 
                    setNotification({title: "Usuario Creado", message: `A√±adido: ${newUser.name}`});
                } catch (e) { setNotification({title: "Error", message: "Fallo al guardar."}); }
            };
            
            const handleDeleteUser = (pin) => {
                if (currentUser && users[pin].name === currentUser.name) { setNotification({title: "Denegado", message: "No puedes borrarte a ti mismo."}); return; }
                requestConfirm("Eliminar Usuario", `¬øEliminar a ${users[pin].name}?`, async () => {
                    await getCollectionRef('users').doc(pin).delete();
                });
            };
            
            return (
                <div className="pb-24 pt-4 px-4 max-w-4xl mx-auto space-y-6">
                    <Card className="p-6">
                        <h2 className="text-xl font-bold text-white mb-4 flex items-center gap-2"><UserPlus size={20} className={theme.text}/> Crear Usuario</h2>
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                            <Input themeColors={theme} label="PIN (4)" value={newUser.pin} onChange={e => {const val = e.target.value.replace(/[^0-9]/g, ''); if (val.length <= 4) setNewUser({...newUser, pin: val});}} placeholder="0000" maxLength={4}/>
                            <Input themeColors={theme} label="Nombre" value={newUser.name} onChange={e => setNewUser({...newUser, name: e.target.value})} placeholder="Empleado" />
                            <Select themeColors={theme} label="Rol" value={newUser.role} onChange={e => setNewUser({...newUser, role: e.target.value})} options={[{value: 'user', label: 'Caja'}, {value: 'admin', label: 'Admin'}]}/>
                            <Button themeColors={theme} onClick={handleAddUser}><Plus size={18} /> Crear</Button>
                        </div>
                    </Card>
                    <div className="bg-slate-800 rounded-xl overflow-hidden border border-slate-700">
                        <div className="p-4 border-b border-slate-700 font-bold text-white flex items-center gap-2"><Users size={20} className="text-slate-400"/> Personal</div>
                        <table className="w-full text-left text-sm text-slate-300">
                            <thead className="bg-slate-900 text-slate-400 uppercase text-xs"><tr><th className="p-4">PIN</th><th className="p-4">Nombre</th><th className="p-4">Rol</th><th className="p-4 text-center">Acci√≥n</th></tr></thead>
                            <tbody className="divide-y divide-slate-700">{Object.entries(users).map(([pin, user]) => (
                                <tr key={pin} className="hover:bg-slate-700/50 transition-colors">
                                    <td className="p-4 font-mono text-slate-400">{pin}</td><td className="p-4 font-medium text-white">{user.name}</td>
                                    <td className="p-4">{user.role === 'admin' ? <span className={`inline-flex items-center gap-1 ${theme.badge} px-2 py-1 rounded text-xs border ${theme.border.replace('border-', 'border-')}/20`}><Shield size={12} /> Admin</span> : <span className="inline-flex items-center gap-1 bg-slate-700 text-slate-300 px-2 py-1 rounded text-xs"><User size={12} /> Personal</span>}</td>
                                    <td className="p-4 text-center"><button onClick={() => handleDeleteUser(pin)} className="text-slate-500 hover:text-red-400 transition-colors"><Trash2 size={18} /></button></td>
                                </tr>
                            ))}</tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const ReportsView = ({ sales, theme, handleVoidLastSale }) => {
            const [filterDate, setFilterDate] = useState(new Date().toISOString().split('T')[0]);
            const filteredSales = sales.filter(s => s.date.startsWith(filterDate));
            const totalUSD = filteredSales.reduce((acc, s) => acc + s.totalUSD, 0);
            const totalVES = filteredSales.reduce((acc, s) => acc + s.totalVES, 0);
            const downloadCSV = () => {
                const headers = ["ID", "Fecha", "Usuario", "Metodo", "Items", "Total USD", "Total VES", "Tasa"].join(",");
                const rows = filteredSales.map(s => {
                    const itemSummary = s.items.map(i => `${i.qty}x ${i.name}`).join(" | ");
                    return [s.id, new Date(s.date).toLocaleString(), s.user || 'N/A', s.method, `"${itemSummary}"`, s.totalUSD, s.totalVES, s.rateAtMoment].join(",");
                });
                const link = document.createElement("a"); link.setAttribute("href", encodeURI("data:text/csv;charset=utf-8," + [headers, ...rows].join("\n"))); link.setAttribute("download", `ventas_${filterDate}.csv`); document.body.appendChild(link); link.click();
            };
            return (
                <div className="pb-24 pt-4 px-4 max-w-4xl mx-auto space-y-6">
                    <div className="flex flex-col md:flex-row justify-between items-end gap-4">
                        <Input themeColors={theme} label="Fecha" type="date" value={filterDate} onChange={e => setFilterDate(e.target.value)} />
                        <div className="flex gap-2">
                            <Button onClick={handleVoidLastSale} variant="danger" className="border border-red-600" title="Eliminar la √∫ltima venta registrada"><RotateCcw size={18}/> Anular √öltima</Button>
                            <Button themeColors={theme} onClick={downloadCSV} variant="secondary"><FileSpreadsheet size={18} /> Exportar</Button>
                        </div>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <Card className="p-6 flex items-center gap-4"><div className={`${theme.lightBg} p-3 rounded-full ${theme.text}`}><DollarSign size={24} /></div><div><p className="text-slate-400 text-xs uppercase font-bold">Ventas USD</p><p className="text-2xl font-bold text-white">${totalUSD.toFixed(2)}</p></div></Card>
                        <Card className="p-6 flex items-center gap-4"><div className="bg-blue-500/20 p-3 rounded-full text-blue-400"><TrendingUp size={24} /></div><div><p className="text-slate-400 text-xs uppercase font-bold">Ventas Bs</p><p className="text-2xl font-bold text-white">Bs. {totalVES.toLocaleString('es-VE', { minimumFractionDigits: 2 })}</p></div></Card>
                        <Card className="p-6 flex items-center gap-4"><div className="bg-purple-500/20 p-3 rounded-full text-purple-400"><ClipboardList size={24} /></div><div><p className="text-slate-400 text-xs uppercase font-bold">Transacciones</p><p className="text-2xl font-bold text-white">{filteredSales.length}</p></div></Card>
                    </div>
                    <div className="bg-slate-800 rounded-xl overflow-hidden border border-slate-700 overflow-x-auto">
                        <div className="p-4 border-b border-slate-700 font-bold text-white">Ventas del {filterDate}</div>
                        <table className="w-full text-left text-sm text-slate-300 min-w-[600px]">
                            <thead className="bg-slate-900 text-slate-400 uppercase text-xs"><tr><th className="p-3">Hora</th><th className="p-3">Estado</th><th className="p-3">Usuario</th><th className="p-3">M√©todo</th><th className="p-3 text-right">Total $</th><th className="p-3 text-right">Total Bs</th></tr></thead>
                            <tbody className="divide-y divide-slate-700">{filteredSales.map(sale => (
                                <tr key={sale.id}>
                                    <td className="p-3 text-xs text-slate-400">{new Date(sale.date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</td>
                                    <td className="p-3 text-xs">{sale.isClosed ? <span className="flex items-center gap-1 text-slate-500"><Archive size={12}/> Cerrado</span> : <span className={theme.text}>Abierto</span>}</td>
                                    <td className={`p-3 text-xs ${theme.text} font-medium`}>{sale.user || 'Anon'}</td><td className="p-3"><span className="bg-slate-700 px-2 py-1 rounded-md text-xs">{sale.method}</span></td>
                                    <td className={`p-3 text-right font-mono ${theme.text}`}>${sale.totalUSD.toFixed(2)}</td><td className="p-3 text-right font-mono text-slate-400">{sale.totalVES.toFixed(2)}</td>
                                </tr>
                            ))}</tbody>
                        </table>
                    </div>
                </div>
            );
        };

        const LoginScreen = ({ users, setCurrentUser, setView, sales, theme }) => {
            const [pin, setPin] = useState(''); 
            const [error, setError] = useState(false); 
            const recentActivity = sales.slice(0, 4);
            const dailyStats = useDailyStats(sales);

            useEffect(() => { 
                if (pin.length === 4) { 
                    const u = users[pin]; 
                    if (u) { 
                        setCurrentUser(u); 
                        setView('pos'); 
                    } else { 
                        setError(true); 
                        setTimeout(() => { setPin(''); setError(false); }, 500); 
                    } 
                } 
            }, [pin]);

            return (
                <div className={`min-h-screen bg-slate-950 flex flex-col items-center justify-center p-4 text-slate-200 animate-in fade-in duration-500 ${theme.selection}`}>
                    <div className="w-full max-w-5xl grid grid-cols-1 lg:grid-cols-2 gap-12 items-center">
                        <div className="flex flex-col items-center w-full max-w-xs mx-auto order-2 lg:order-1">
                            <div className="mb-8 text-center">
                                <h1 className={`text-4xl font-bold ${theme.text} tracking-tight mb-1`}>TipKeeper</h1>
                                <span className="text-xs text-slate-500 font-mono bg-slate-900 px-2 py-1 rounded-full">{APP_VERSION}</span>
                                <p className="text-[10px] text-slate-600 font-mono leading-none mt-2">concept & code by: @leonelo.jpg ft @xitocore</p>
                            </div>
                            <div className="w-full"><div className={`bg-slate-900 h-16 rounded-2xl mb-6 flex items-center justify-center gap-4 border ${error ? 'border-red-500/50 animate-pulse' : 'border-slate-800'}`}>{Array(4).fill(0).map((_, i) => <div key={i} className={`w-4 h-4 rounded-full transition-all ${i < pin.length ? `${theme.bg} scale-110` : 'bg-slate-700'}`} />)}</div>
                            <div className="grid grid-cols-3 gap-4 mb-8">{[1,2,3,4,5,6,7,8,9].map(n => <button key={n} onClick={() => setPin(p => p.length < 4 ? p + n : p)} className="h-16 bg-slate-800 hover:bg-slate-700 rounded-2xl text-2xl font-bold text-white active:scale-95 border-b-4 border-slate-900 active:border-b-0 active:translate-y-1">{n}</button>)}<div className="h-16 flex items-center justify-center"><Lock size={20} className="text-slate-600" /></div><button onClick={() => setPin(p => p.length < 4 ? p + '0' : p)} className="h-16 bg-slate-800 hover:bg-slate-700 rounded-2xl text-2xl font-bold text-white active:scale-95 border-b-4 border-slate-900 active:border-b-0 active:translate-y-1">0</button><button onClick={() => setPin(p => p.slice(0, -1))} className="h-16 flex items-center justify-center bg-slate-800 hover:bg-red-500/20 text-slate-400 hover:text-red-400 rounded-2xl active:scale-95 border-b-4 border-slate-900 active:border-b-0 active:translate-y-1"><X size={24} /></button></div></div>
                        </div>
                        <div className="w-full max-w-md mx-auto order-1 lg:order-2 mb-8 lg:mb-0 space-y-6">
                            {dailyStats && (
                                <div className="grid grid-cols-2 gap-4">
                                    <div className="bg-slate-900/80 border border-slate-800 p-4 rounded-2xl backdrop-blur-sm flex flex-col items-center text-center">
                                        <div className="bg-pink-500/10 p-2 rounded-full text-pink-400 mb-2"><Heart size={20}/></div>
                                        <p className="text-[10px] text-slate-500 uppercase font-bold tracking-wider">Favorito del d√≠a üíñ</p>
                                        <p className="text-sm font-bold text-white line-clamp-1">{dailyStats.topItem.name}</p>
                                        <span className="text-[10px] text-slate-400">{dailyStats.topItem.count} vendidos</span>
                                    </div>
                                    <div className="bg-slate-900/80 border border-slate-800 p-4 rounded-2xl backdrop-blur-sm flex flex-col items-center text-center">
                                        <div className={`bg-indigo-500/10 p-2 rounded-full ${theme.text} mb-2`}><Trophy size={20}/></div>
                                        <p className="text-[10px] text-slate-500 uppercase font-bold tracking-wider">MVP del d√≠a üëë</p>
                                        <p className="text-sm font-bold text-white line-clamp-1">{dailyStats.topUser.name}</p>
                                        <span className="text-[10px] text-slate-400">{dailyStats.topUser.count} ventas</span>
                                    </div>
                                </div>
                            )}

                            <div className="bg-slate-900/50 border border-slate-800 rounded-2xl p-6 backdrop-blur-sm">
                                <div className="flex items-center justify-between mb-4 border-b border-slate-800 pb-4"><div className={`flex items-center gap-2 ${theme.text}`}><Activity size={20} /><h3 className="font-bold text-sm uppercase tracking-wider">Actividad Reciente</h3></div></div>
                                <div className="space-y-3">{recentActivity.length === 0 ? <div className="text-center py-8 text-slate-600 text-sm italic">Esperando ventas...</div> : recentActivity.map(s => <div key={s.id} className="bg-slate-900 border border-slate-800 p-3 rounded-xl flex justify-between"><div className="flex-1 min-w-0 pr-4"><div className="flex items-center gap-2 mb-1"><span className="text-xs font-bold text-white">${s.totalUSD.toFixed(2)}</span><span className="text-[10px] text-slate-400 bg-slate-800 px-1.5 py-0.5 rounded border border-slate-700 uppercase tracking-wider">{s.method}</span></div><p className="text-[10px] text-slate-400 truncate">{s.items.map(i => `${i.qty} ${i.name}`).join(', ')}</p></div><div className="text-right"><div className="text-[10px] text-slate-500 font-mono mb-1">{new Date(s.date).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div><div className="text-[9px] text-white font-bold uppercase bg-slate-800 px-2 py-1 rounded-full inline-block">{s.user}</div></div></div>)}</div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        
        const POSView = ({ menu, cart, sales, addToCart, updateQty, theme, cartTotalUSD, cartTotalVES, processSale, clearCart, tasa, setIsSplitPaymentOpen, setIsMobileCartOpen, isMobileCartOpen, setIsCustomItemModalOpen, setCustomItemBase }) => {
            const [selectedCategory, setSelectedCategory] = useState('Todos');
            const [clickedId, setClickedId] = useState(null); 
            const categories = ['Todos', ...new Set(menu.map(i => i.category))];
            
            const itemPopularity = useMemo(() => {
                const stats = {};
                sales.forEach(sale => {
                    sale.items.forEach(item => {
                        stats[item.id] = (stats[item.id] || 0) + item.qty;
                    });
                });
                return stats;
            }, [sales]);

            const filteredMenu = useMemo(() => {
                let items = selectedCategory === 'Todos' ? menu : menu.filter(i => i.category === selectedCategory);
                if (selectedCategory === 'Todos') {
                    return [...items].sort((a, b) => (itemPopularity[b.id] || 0) - (itemPopularity[a.id] || 0));
                }
                return items;
            }, [menu, selectedCategory, itemPopularity]);

            const handleItemClick = (item) => {
                if (item.category === 'Otros' || item.id === 901) {
                    setCustomItemBase(item);
                    setIsCustomItemModalOpen(true);
                    return;
                }

                addToCart(item);
                setClickedId(item.id);
                setTimeout(() => setClickedId(null), 200); 
            };

            const totalItemsInCart = useMemo(() => cart.reduce((acc, item) => acc + item.qty, 0), [cart]);

            return (
                <React.Fragment>
                    <div className="pb-24 pt-4 px-4 max-w-5xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div className="lg:col-span-2 space-y-4">
                            <div className="flex gap-2 overflow-x-auto pb-2 scrollbar-hide">
                                {categories.map(cat => {
                                    const style = CATEGORY_STYLES[cat] || CATEGORY_STYLES['default'];
                                    return (
                                        <button key={cat} onClick={() => setSelectedCategory(cat)} className={`px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap transition-colors ${selectedCategory === cat ? `${theme.bg} text-white` : 'bg-slate-800 text-slate-300 hover:bg-slate-700'} flex items-center gap-2`}>
                                            {cat !== 'Todos' && <span>{style.emoji}</span>}
                                            {cat}
                                        </button>
                                    );
                                })}
                            </div>
                            <div className="grid grid-cols-2 sm:grid-cols-3 gap-3">
                                {filteredMenu.map(item => {
                                    const isDisabled = item.trackStock && item.stock <= 0;
                                    const isClicked = clickedId === item.id;
                                    const isPopular = selectedCategory === 'Todos' && itemPopularity[item.id] > 0;
                                    const catStyle = CATEGORY_STYLES[item.category] || CATEGORY_STYLES['default'];
                                    
                                    return (
                                        <button 
                                            key={item.id} 
                                            onClick={() => handleItemClick(item)} 
                                            disabled={isDisabled} 
                                            className={`p-4 rounded-xl text-left border transition-all group relative overflow-hidden active:scale-95
                                                ${isDisabled ? 'bg-slate-800 border-slate-700 opacity-50 grayscale cursor-not-allowed' : 
                                                    isClicked ? `bg-slate-700 border-emerald-500 ring-2 ring-emerald-500/50 flash-click` : 
                                                    `bg-slate-800 ${selectedCategory === 'Todos' ? catStyle.border : 'border-slate-700'} hover:${theme.border} hover:bg-slate-700/50`
                                                }`}
                                        >
                                            {selectedCategory === 'Todos' && <div className={`absolute top-0 right-0 px-2 py-0.5 text-[10px] rounded-bl-lg ${catStyle.bg} ${catStyle.color}`}>{catStyle.emoji} {item.category}</div>}
                                            
                                            <div className="flex justify-between items-start mb-2 mt-1">
                                                <span className={`font-bold text-white group-hover:${theme.text} truncate pr-2`}>{item.name}</span>
                                                {item.trackStock ? (<span className={`text-xs px-2 py-1 rounded ${item.stock < 10 ? 'bg-red-900 text-red-300' : 'bg-slate-900 text-slate-400'}`}>{item.stock}</span>) : (<span className="text-slate-600"><InfinityIcon size={16} /></span>)}
                                            </div>
                                            <div className="flex justify-between items-end">
                                                <div className="flex flex-col"><span className={`text-lg font-mono ${theme.text}`}>${item.price}</span><span className="text-xs text-slate-500 font-mono">Bs. {(item.price * tasa).toFixed(2)}</span></div>
                                                {isPopular && <div className="text-orange-500/50 text-[10px] flex items-center gap-1"><Flame size={12}/> {itemPopularity[item.id]}</div>}
                                            </div>
                                        </button>
                                    );
                                })}
                            </div>
                        </div>

                        <div className="hidden lg:block lg:col-span-1">
                            <Card className="p-4 sticky top-24 h-[calc(100vh-150px)] flex flex-col">
                                <h2 className="text-lg font-bold text-white mb-4 flex items-center gap-2"><ShoppingCart size={20} /> Cuenta Actual</h2>
                                <CartContent cart={cart} updateQty={updateQty} theme={theme} cartTotalUSD={cartTotalUSD} cartTotalVES={cartTotalVES} processSale={processSale} clearCart={clearCart} onSplitPayment={() => setIsSplitPaymentOpen(true)} />
                            </Card>
                        </div>
                    </div>

                    <div className="fixed bottom-20 right-4 z-30 lg:hidden">
                        <button 
                            onClick={() => setIsMobileCartOpen(true)}
                            className={`flex items-center gap-3 px-4 py-3 rounded-full shadow-2xl transition-all active:scale-95 ${cart.length > 0 ? theme.bg : 'bg-slate-700'} text-white`}
                        >
                            <div className="relative">
                                <ShoppingCart size={24} />
                                {totalItemsInCart > 0 && <span className="absolute -top-2 -right-2 bg-red-500 text-white text-[10px] font-bold w-5 h-5 flex items-center justify-center rounded-full border-2 border-slate-900">{totalItemsInCart}</span>}
                            </div>
                            <div className="flex flex-col items-start leading-none">
                                <span className="text-[10px] uppercase font-bold opacity-80">Total</span>
                                <span className="font-mono font-bold">${cartTotalUSD.toFixed(2)}</span>
                            </div>
                        </button>
                    </div>

                    {isMobileCartOpen && (
                        <div className="fixed inset-0 z-50 lg:hidden flex flex-col bg-slate-950 animate-in slide-up">
                            <div className="bg-slate-900 border-b border-slate-800 p-4 flex items-center justify-between shrink-0">
                                <h2 className="text-lg font-bold text-white flex items-center gap-2"><ShoppingCart size={20} className={theme.text} /> Tu Orden</h2>
                                <button onClick={() => setIsMobileCartOpen(false)} className="bg-slate-800 p-2 rounded-full hover:bg-slate-700 text-slate-400 hover:text-white transition-colors"><X size={20} /></button>
                            </div>
                            <div className="flex-1 overflow-hidden p-4">
                                <CartContent cart={cart} updateQty={updateQty} theme={theme} cartTotalUSD={cartTotalUSD} cartTotalVES={cartTotalVES} processSale={processSale} clearCart={clearCart} onSplitPayment={() => setIsSplitPaymentOpen(true)} />
                            </div>
                        </div>
                    )}
                </React.Fragment>
            );
        };

        // --- MODAL DE PAGO MIXTO ---
        const MixedPaymentModal = ({ isOpen, onClose, totalUSD, onConfirm, theme }) => {
            if (!isOpen) return null;
            
            const [amount1, setAmount1] = useState('');
            const [method1, setMethod1] = useState('Efectivo');
            const [amount2, setAmount2] = useState('');
            const [method2, setMethod2] = useState('Pago M√≥vil');
            const [error, setError] = useState('');
            
            const handleAmount1Change = (e) => {
                const val = e.target.value;
                setAmount1(val);
                if (val && !isNaN(val)) {
                    const remaining = Math.max(0, totalUSD - parseFloat(val));
                    setAmount2(remaining.toFixed(2));
                }
            };

            const handleConfirm = () => {
                const val1 = parseFloat(amount1) || 0;
                const val2 = parseFloat(amount2) || 0;
                if (Math.abs((val1 + val2) - totalUSD) < 0.05) {
                    const description = `Mixto: ${method1} $${val1.toFixed(2)} / ${method2} $${val2.toFixed(2)}`;
                    onConfirm(description);
                } else {
                    setError(`Los montos deben sumar $${totalUSD.toFixed(2)}`);
                    setTimeout(() => setError(''), 3000);
                }
            };

            return (
                <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in">
                    <div className="bg-slate-800 rounded-2xl w-full max-w-sm border border-slate-700 shadow-2xl">
                        <div className="p-4 border-b border-slate-700 flex justify-between items-center">
                            <h3 className="text-lg font-bold text-white flex items-center gap-2"><Split size={20} className={theme.text}/> Pago Dividido</h3>
                            <button onClick={onClose} className="text-slate-400 hover:text-white"><X size={20}/></button>
                        </div>
                        <div className="p-6 space-y-4">
                            <div className="text-center mb-4">
                                <p className="text-slate-400 text-xs uppercase">Total a Pagar</p>
                                <p className="text-3xl font-bold text-white font-mono">${totalUSD.toFixed(2)}</p>
                            </div>
                            
                            <div className="space-y-2">
                                <div className="flex gap-2">
                                    <div className="w-1/2">
                                        <Select themeColors={theme} label="M√©todo 1" value={method1} onChange={e => setMethod1(e.target.value)} options={[{value:'Efectivo', label:'Efectivo'}, {value:'Pago M√≥vil', label:'Pago M√≥vil'}, {value:'Tarjeta', label:'Punto'}, {value:'Zelle', label:'Zelle'}]} />
                                    </div>
                                    <div className="w-1/2">
                                        <Input themeColors={theme} label="Monto ($)" type="number" value={amount1} onChange={handleAmount1Change} placeholder="0.00" />
                                    </div>
                                </div>
                                <div className="flex gap-2">
                                    <div className="w-1/2">
                                        <Select themeColors={theme} label="M√©todo 2" value={method2} onChange={e => setMethod2(e.target.value)} options={[{value:'Efectivo', label:'Efectivo'}, {value:'Pago M√≥vil', label:'Pago M√≥vil'}, {value:'Tarjeta', label:'Punto'}, {value:'Zelle', label:'Zelle'}]} />
                                    </div>
                                    <div className="w-1/2">
                                        <Input themeColors={theme} label="Monto ($)" type="number" value={amount2} onChange={e => setAmount2(e.target.value)} placeholder="Restante" />
                                    </div>
                                </div>
                            </div>
                            
                            {error && <div className="bg-red-500/10 text-red-400 text-xs p-2 rounded text-center border border-red-500/20">{error}</div>}

                            <Button themeColors={theme} onClick={handleConfirm} className="w-full mt-4"><Check size={18}/> Confirmar Pago</Button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- CONFIRMACIONES Y MODALES GEN√âRICOS ---
        const ConfirmationModal = ({ isOpen, onClose, title, message, onConfirm, theme }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in">
                    <div className="bg-slate-800 rounded-2xl w-full max-w-sm border border-slate-700 shadow-2xl">
                        <div className="p-4 border-b border-slate-700 flex justify-between items-center">
                            <h3 className="text-lg font-bold text-white flex items-center gap-2"><AlertTriangle size={20} className="text-amber-500"/> {title}</h3>
                            <button onClick={onClose} className="text-slate-400 hover:text-white"><X size={20}/></button>
                        </div>
                        <div className="p-6 space-y-4">
                            <p className="text-slate-300 text-center">{message}</p>
                            <div className="grid grid-cols-2 gap-3 pt-2">
                                <Button onClick={onClose} variant="secondary" themeColors={theme}>Cancelar</Button>
                                <Button onClick={onConfirm} variant="warning" themeColors={theme}>Confirmar</Button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const CustomItemModal = ({ isOpen, onClose, onConfirm, theme }) => {
            if (!isOpen) return null;
            const [description, setDescription] = useState('');
            const [price, setPrice] = useState('');

            const handleSubmit = () => {
                if (!description || !price) return;
                onConfirm(description, parseFloat(price));
                setDescription('');
                setPrice('');
                onClose();
            };

            return (
                <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in">
                    <div className="bg-slate-800 rounded-2xl w-full max-w-sm border border-slate-700 shadow-2xl">
                        <div className="p-4 border-b border-slate-700 flex justify-between items-center">
                            <h3 className="text-lg font-bold text-white flex items-center gap-2"><Pencil size={20} className={theme.text}/> Servicio Personalizado</h3>
                            <button onClick={onClose} className="text-slate-400 hover:text-white"><X size={20}/></button>
                        </div>
                        <div className="p-6 space-y-4">
                            <Input themeColors={theme} label="Descripci√≥n del Servicio" value={description} onChange={e => setDescription(e.target.value)} placeholder="Ej. Descorche, Evento..." />
                            <Input themeColors={theme} label="Monto a Cobrar ($)" type="number" value={price} onChange={e => setPrice(e.target.value)} placeholder="0.00" />
                            <Button themeColors={theme} onClick={handleSubmit} className="w-full mt-4" disabled={!description || !price}><Plus size={18}/> Agregar a la Cuenta</Button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- APP PRINCIPAL ---
        function App() {
            const [users, setUsers] = useState({});
            const [currentUser, setCurrentUser] = useState(null);
            const [view, setView] = useState('pos'); 
            const [tasa, setTasa] = useState(0);
            const [menu, setMenu] = useState([]);
            const [cart, setCart] = useState([]);
            const [sales, setSales] = useState([]);
            const [themeKey, setThemeKey] = useState('astro'); 
            const [showThemeMenu, setShowThemeMenu] = useState(false);
            const [showMobileMenu, setShowMobileMenu] = useState(false); 
            const [isMobileCartOpen, setIsMobileCartOpen] = useState(false); 
            const [isLoading, setIsLoading] = useState(true);
            
            const [isRateModalOpen, setIsRateModalOpen] = useState(false);
            const [isLogoutConfirmOpen, setIsLogoutConfirmOpen] = useState(false);
            const [isDailyCloseOpen, setIsDailyCloseOpen] = useState(false); 
            const [isSplitPaymentOpen, setIsSplitPaymentOpen] = useState(false); 
            
            const [isCustomItemModalOpen, setIsCustomItemModalOpen] = useState(false);
            const [customItemBase, setCustomItemBase] = useState(null);

            const [notification, setNotification] = useState(null);
            const [isResetConfirmOpen, setIsResetConfirmOpen] = useState(false); // New Factory Reset Modal
            
            const [confirmConfig, setConfirmConfig] = useState({ isOpen: false, title: '', message: '', onConfirm: null });
            
            const theme = useMemo(() => THEMES[themeKey].colors, [themeKey]);
            
            // --- INITIALIZATION AND SYNC ---
            useEffect(() => {
                const initApp = async () => {
                    // 1. Auth
                    if (!auth) return; // Safety check

                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await auth.signInWithCustomToken(__initial_auth_token);
                    } else {
                        await auth.signInAnonymously();
                    }

                    const user = auth.currentUser;
                    if (!user) return;

                    // 2. Sync Data
                    const unsubs = [];
                    
                    // MENU
                    const menuRef = getCollectionRef('menu');
                    if (menuRef) {
                        unsubs.push(menuRef.onSnapshot(snapshot => {
                            if (snapshot.empty) {
                                // Seed initial menu if empty
                                const batch = db.batch();
                                INITIAL_MENU.forEach(item => batch.set(getCollectionRef('menu').doc(String(item.id)), item));
                                batch.commit().then(() => console.log("Menu seeded"));
                            } else {
                                const items = snapshot.docs.map(d => d.data());
                                setMenu(items);
                            }
                        }));
                    }

                    // SALES
                    const salesRef = getCollectionRef('sales');
                    if (salesRef) {
                        unsubs.push(salesRef.orderBy('date', 'desc').onSnapshot(snapshot => {
                            const loadedSales = snapshot.docs.map(d => d.data());
                            setSales(loadedSales);
                        }));
                    }

                    // USERS
                    const usersRef = getCollectionRef('users');
                    if (usersRef) {
                        unsubs.push(usersRef.onSnapshot(snapshot => {
                            if (snapshot.empty) {
                                // Seed initial users if empty
                                const batch = db.batch();
                                Object.entries(INITIAL_USERS).forEach(([pin, data]) => batch.set(getCollectionRef('users').doc(pin), data));
                                batch.commit().then(() => console.log("Users seeded"));
                            } else {
                                const loadedUsers = {};
                                snapshot.docs.forEach(d => loadedUsers[d.id] = d.data());
                                setUsers(loadedUsers);
                            }
                        }));
                    }

                    // CONFIG (Tasa)
                    const configRef = getConfigRef();
                    if (configRef) {
                        unsubs.push(configRef.onSnapshot(doc => {
                            if (doc.exists) {
                                setTasa(doc.data().tasa || 0);
                            } else {
                                configRef.set({ tasa: 230.80 }); // Default
                            }
                            setIsLoading(false);
                        }));
                    }

                    // Theme (Local Preference)
                    const savedTheme = localStorage.getItem('tipkeeper_theme');
                    if (savedTheme && THEMES[savedTheme]) setThemeKey(savedTheme);

                    return () => unsubs.forEach(u => u());
                };

                initApp();
            }, []);

            useEffect(() => {
                localStorage.setItem('tipkeeper_theme', themeKey);
            }, [themeKey]);

            useEffect(() => {
                if (notification) { const timer = setTimeout(() => setNotification(null), 3000); return () => clearTimeout(timer); }
            }, [notification]);

            // Update Rate in Firebase
            const updateTasa = (newTasa) => {
                getConfigRef().update({ tasa: newTasa });
                setTasa(newTasa); // Optimistic update
            };

            // --- ACTIONS ---

            const requestConfirm = (title, message, onConfirmAction) => {
                setConfirmConfig({ isOpen: true, title, message, onConfirm: () => { onConfirmAction(); setConfirmConfig(prev => ({...prev, isOpen: false})); } });
            };

            const addToCart = (item) => {
                if (window.navigator && window.navigator.vibrate) window.navigator.vibrate(50);
                setCart(prev => {
                    const existing = prev.find(i => i.id === item.id);
                    if (existing) return prev.map(i => i.id === item.id ? { ...i, qty: i.qty + 1 } : i);
                    return [...prev, { ...item, qty: 1 }];
                });
            };
            
            const addCustomToCart = (desc, price) => {
                if (!customItemBase) return;
                const newItem = {
                    ...customItemBase,
                    id: `custom-${Date.now()}`, // Unique ID to allow multiple custom items
                    name: desc,
                    price: price,
                    qty: 1,
                    isCustom: true
                };
                addToCart(newItem);
            };

            const updateQty = (id, delta) => {
                setCart(prev => prev.map(i => {
                    if (i.id === id) { const newQty = Math.max(1, i.qty + delta); return { ...i, qty: newQty }; }
                    return i;
                }));
            };

            const clearCart = () => { setCart([]); setIsMobileCartOpen(false); };
            const cartTotalUSD = useMemo(() => cart.reduce((acc, item) => acc + (item.price * item.qty), 0), [cart]);
            const cartTotalVES = useMemo(() => cartTotalUSD * tasa, [cartTotalUSD, tasa]);

            const processSale = async (method) => {
                if (cart.length === 0) return;
                const saleId = Date.now();
                const newSale = {
                    id: saleId, date: new Date().toISOString(), items: cart, totalUSD: cartTotalUSD, totalVES: cartTotalVES,
                    rateAtMoment: tasa, method: method, user: currentUser.name, isClosed: false 
                };

                try {
                    const batch = db.batch();
                    // 1. Save Sale
                    batch.set(getCollectionRef('sales').doc(String(saleId)), newSale);
                    
                    // 2. Update Stock
                    cart.forEach(cartItem => {
                        if (cartItem.isCustom) return; // Don't track stock for custom items
                        const menuItem = menu.find(m => m.id === cartItem.id);
                        if (menuItem && menuItem.trackStock) {
                            const newStock = menuItem.stock - cartItem.qty;
                            batch.update(getCollectionRef('menu').doc(String(menuItem.id)), { stock: newStock });
                        }
                    });

                    await batch.commit();
                    setCart([]); setIsMobileCartOpen(false); setIsSplitPaymentOpen(false); 
                    setNotification({ title: "¬°Venta Exitosa!", message: `Cobrado: $${cartTotalUSD.toFixed(2)}` });
                } catch (e) { console.error(e); setNotification({ title: "Error", message: "Fallo al procesar venta." }); }
            };

            const handleVoidLastSale = () => {
                if (sales.length === 0) { setNotification({ title: "Error", message: "No hay ventas." }); return; }
                requestConfirm("Anular Venta", "¬øEst√°s seguro de anular la √öLTIMA venta registrada? Esto devolver√° los items al inventario.", async () => {
                    const lastSale = sales[0]; // Sales are ordered desc
                    try {
                        const batch = db.batch();
                        // 1. Delete Sale
                        batch.delete(getCollectionRef('sales').doc(String(lastSale.id)));
                        
                        // 2. Restore Stock
                        lastSale.items.forEach(soldItem => {
                            if (soldItem.isCustom) return;
                            const menuItem = menu.find(m => m.id === soldItem.id);
                            if (menuItem && menuItem.trackStock) {
                                const newStock = menuItem.stock + soldItem.qty;
                                batch.update(getCollectionRef('menu').doc(String(menuItem.id)), { stock: newStock });
                            }
                        });
                        await batch.commit();
                        setNotification({ title: "Venta Anulada", message: `Reversada venta de $${lastSale.totalUSD.toFixed(2)}` });
                    } catch(e) { console.error(e); setNotification({ title: "Error", message: "Fallo al anular." }); }
                });
            };
            
            const performFactoryReset = async () => {
                try {
                    // Helper to clear a collection
                    const clearCollection = async (name) => {
                        const snapshot = await getCollectionRef(name).get();
                        const batch = db.batch();
                        snapshot.docs.forEach(doc => batch.delete(doc.ref));
                        await batch.commit();
                    };

                    await clearCollection('sales');
                    await clearCollection('menu');
                    await clearCollection('users');
                    await getConfigRef().delete();

                    // Data will re-seed automatically via onSnapshot empty check
                    setIsResetConfirmOpen(false);
                    setNotification({ title: "Reset Completo", message: "App restaurada de f√°brica." });
                    window.location.reload(); // Reload to force re-seed cleanly
                } catch(e) { console.error(e); setNotification({ title: "Error", message: "Fallo en Factory Reset" }); }
            };

            const performDailyClose = (salesToClose) => {
                const today = new Date().toISOString().split('T')[0];
                // Generate CSV
                const headers = ["ID", "Fecha", "Usuario", "Metodo", "Items", "Total USD", "Total VES", "Tasa"].join(",");
                const rows = salesToClose.map(s => {
                    const itemSummary = s.items.map(i => `${i.qty}x ${i.name}`).join(" | ");
                    return [s.id, new Date(s.date).toLocaleString(), s.user, s.method, `"${itemSummary}"`, s.totalUSD, s.totalVES, s.rateAtMoment].join(",");
                });
                const csvContent = "data:text/csv;charset=utf-8," + [headers, ...rows].join("\n");
                const link = document.createElement("a"); link.setAttribute("href", encodeURI(csvContent)); link.setAttribute("download", `CIERRE_Z_${today}_${Date.now()}.csv`); document.body.appendChild(link); link.click();

                // Update sales to closed in Firebase
                const batch = db.batch();
                salesToClose.forEach(s => {
                    batch.update(getCollectionRef('sales').doc(String(s.id)), { isClosed: true });
                });
                batch.commit().then(() => {
                    setNotification({ title: "Cierre Exitoso", message: "D√≠a reseteado y reporte descargado." }); 
                    setIsDailyCloseOpen(false);
                }).catch(e => setNotification({ title: "Error", message: "Fallo al cerrar d√≠a." }));
            };

            const Header = () => (
                <div className="bg-slate-900 border-b border-slate-800 p-4 sticky top-0 z-20 shadow-md">
                    <div className="max-w-5xl mx-auto flex justify-between items-center relative">
                        <div className="relative">
                            <button onClick={() => setShowThemeMenu(!showThemeMenu)} className="text-left focus:outline-none group">
                                <div className="flex items-baseline gap-2">
                                    <h1 className={`text-2xl font-bold ${theme.text} tracking-tight`}>TipKeeper</h1>
                                    <span className="text-[10px] text-slate-500 font-mono">{APP_VERSION}</span>
                                    <span className="text-[10px] text-emerald-500/80 font-mono border-l border-slate-800 pl-2 ml-1 uppercase tracking-wider hidden sm:inline-block">Licensed for VADAS BAR</span>
                                </div>
                                <p className="text-[10px] text-slate-600 font-mono leading-none mt-0.5">concept & code by: @leonelo.jpg ft @xitocore</p>
                            </button>
                            {showThemeMenu && (
                                <React.Fragment>
                                    <div className="fixed inset-0 z-40" onClick={() => setShowThemeMenu(false)}></div>
                                    <div className="absolute top-12 left-0 mt-2 w-64 bg-slate-900 border border-slate-800 rounded-xl shadow-2xl z-50 overflow-hidden animate-in fade-in slide-in-from-top-5">
                                        <div className="p-3 border-b border-slate-800 bg-slate-950/50"><p className="text-xs font-bold text-slate-500 uppercase tracking-wider flex items-center gap-2"><Palette size={12}/> Seleccionar Tema</p></div>
                                        <div className="p-2 space-y-1 max-h-80 overflow-y-auto">
                                            {Object.values(THEMES).map((t) => (
                                                <button key={t.id} onClick={() => { setThemeKey(t.id); setShowThemeMenu(false); }} className={`w-full flex items-center justify-between p-2 rounded-lg text-sm transition-colors ${themeKey === t.id ? 'bg-slate-800 text-white' : 'text-slate-400 hover:bg-slate-800 hover:text-slate-200'}`}><div className="flex items-center gap-3"><div className={`w-4 h-4 rounded-full ${t.colors.bg}`}></div><span>{t.name}</span></div>{themeKey === t.id && <Check size={14} className={t.colors.text} />}</button>
                                            ))}
                                        </div>
                                    </div>
                                </React.Fragment>
                            )}
                        </div>
                        
                        <div className="hidden md:flex items-center gap-2">
                            <button onClick={() => setIsDailyCloseOpen(true)} className={`bg-slate-800 border border-slate-700 hover:${theme.border} text-slate-400 hover:text-white p-2 rounded-xl transition-all flex flex-col items-center justify-center`} title="Cierre del D√≠a"><Receipt size={20} /></button>
                            <button onClick={() => setIsLogoutConfirmOpen(true)} className="flex items-center gap-2 bg-slate-800/50 pl-3 pr-2 py-1.5 rounded-full border border-slate-700 hover:border-red-500/50 group transition-all relative">
                                <div className="flex flex-col items-end leading-none"><span className={`text-[10px] font-black uppercase ${currentUser.color}`}>{currentUser.name}</span><span className="text-[9px] text-slate-500">Cerrar Sesi√≥n</span></div>
                                <div className="bg-slate-700 p-1.5 rounded-full group-hover:bg-red-500 group-hover:text-white transition-colors text-slate-400"><LogOut size={14} /></div>
                            </button>
                            <button onClick={() => setIsRateModalOpen(true)} className="bg-slate-800 border border-slate-700 hover:bg-slate-700 px-3 py-1.5 rounded-xl flex flex-col items-end transition-colors"><span className="text-[10px] text-slate-400 uppercase font-bold">Tasa</span><span className="text-sm font-mono text-white font-bold">{tasa.toFixed(2)}</span></button>
                        </div>
                        
                        {/* Bot√≥n oculto para admin reset desktop */}
                        {currentUser.role === 'admin' && (
                            <button onClick={() => setIsResetConfirmOpen(true)} className="hidden md:flex absolute right-[-50px] top-4 text-slate-800 hover:text-red-900 transition-colors" title="Factory Reset"><AlertTriangle size={12}/></button>
                        )}

                        <div className="md:hidden">
                            <button onClick={() => setShowMobileMenu(!showMobileMenu)} className={`p-2 rounded-lg ${showMobileMenu ? 'bg-slate-800 text-white' : 'text-slate-400'}`}>
                                {showMobileMenu ? <X size={24}/> : <Menu size={24} />}
                            </button>
                            {showMobileMenu && (
                                <React.Fragment>
                                    <div className="fixed inset-0 z-30" onClick={() => setShowMobileMenu(false)}></div>
                                    <div className="absolute top-14 right-0 w-56 bg-slate-900 border border-slate-800 rounded-xl shadow-2xl z-40 p-2 space-y-1 animate-in fade-in slide-in-from-top-5">
                                        <div className="px-3 py-2 border-b border-slate-800 mb-1">
                                            <div className="text-xs text-slate-500 uppercase font-bold">Usuario Activo</div>
                                            <div className={`font-bold ${currentUser.color}`}>{currentUser.name}</div>
                                        </div>
                                        <button onClick={() => {setIsRateModalOpen(true); setShowMobileMenu(false)}} className="w-full flex items-center justify-between p-3 rounded-lg hover:bg-slate-800 transition-colors text-left">
                                            <span className="text-sm text-slate-300">Tasa de Cambio</span>
                                            <span className="font-mono font-bold text-white bg-slate-800 px-2 py-0.5 rounded border border-slate-700">{tasa.toFixed(2)}</span>
                                        </button>
                                        <button onClick={() => {setIsDailyCloseOpen(true); setShowMobileMenu(false)}} className="w-full flex items-center gap-3 p-3 rounded-lg hover:bg-slate-800 transition-colors text-slate-300 hover:text-white">
                                            <Receipt size={18} /> <span className="text-sm">Cierre del D√≠a</span>
                                        </button>
                                        {currentUser.role === 'admin' && (
                                            <button onClick={() => {setIsResetConfirmOpen(true); setShowMobileMenu(false)}} className="w-full flex items-center gap-3 p-3 rounded-lg hover:bg-red-900/20 text-red-400 hover:text-red-300 transition-colors border border-red-900/30 mb-1">
                                                <RefreshCcw size={18} /> <span className="text-sm font-bold">Factory Reset</span>
                                            </button>
                                        )}
                                        <button onClick={() => {setIsLogoutConfirmOpen(true); setShowMobileMenu(false)}} className="w-full flex items-center gap-3 p-3 rounded-lg hover:bg-red-500/10 text-slate-300 hover:text-red-400 transition-colors">
                                            <LogOut size={18} /> <span className="text-sm">Cerrar Sesi√≥n</span>
                                        </button>
                                    </div>
                                </React.Fragment>
                            )}
                        </div>
                    </div>
                </div>
            );

            const Navigation = () => (
                <div className="fixed bottom-0 left-0 w-full bg-slate-900 border-t border-slate-800 p-2 z-20">
                    <div className="max-w-md mx-auto flex justify-around items-center"> {/* Removed items-end */}
                        <NavButton icon={<Home size={20} />} label="Inicio" active={view === 'dashboard'} onClick={() => setView('dashboard')} />
                        <NavButton icon={<Beer size={20} />} label="Ventas" active={view === 'pos'} onClick={() => setView('pos')} />
                        
                        {currentUser.role === 'admin' && (
                            <React.Fragment>
                                <NavButton icon={<ClipboardList size={20} />} label="Inventario" active={view === 'inventory'} onClick={() => setView('inventory')} />
                                <NavButton icon={<LayoutDashboard size={20} />} label="Reportes" active={view === 'reports'} onClick={() => setView('reports')} />
                                <NavButton icon={<Users size={20} />} label="Usuarios" active={view === 'users'} onClick={() => setView('users')} />
                            </React.Fragment>
                        )}
                    </div>
                </div>
            );
            const NavButton = ({ icon, label, active, onClick }) => (
                <button onClick={onClick} className={`flex flex-col items-center gap-1 p-2 rounded-lg w-20 transition-colors ${active ? `${theme.text} bg-slate-800` : 'text-slate-500 hover:text-slate-300'}`}>
                    {icon} <span className="text-[10px] font-medium">{label}</span>
                </button>
            );

            const RateModal = () => isRateModalOpen ? <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 backdrop-blur-sm"><div className="bg-slate-800 rounded-2xl p-6 w-full max-w-sm border border-slate-700 shadow-2xl"><div className="flex justify-between items-center mb-6"><h3 className="text-xl font-bold text-white">Divisa</h3><button onClick={() => setIsRateModalOpen(false)} className="text-slate-400 hover:text-white"><X size={24}/></button></div><input type="number" defaultValue={tasa} onBlur={e => {const v=parseFloat(e.target.value); if(v>0) updateTasa(v); setIsRateModalOpen(false);}} className={`w-full bg-slate-900 border border-slate-600 rounded-xl px-4 py-4 text-3xl font-bold text-center ${theme.text} focus:ring-2 ${theme.ring} outline-none`} autoFocus /></div></div> : null;
            const LogoutConfirmModal = () => isLogoutConfirmOpen ? <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in"><div className="bg-slate-800 rounded-2xl p-6 w-full max-w-sm border border-slate-700 shadow-2xl"><div className="flex flex-col items-center text-center gap-4"><h3 className="text-xl font-bold text-white">¬øSalir?</h3><div className="grid grid-cols-2 gap-3 w-full"><Button themeColors={theme} variant="secondary" onClick={() => setIsLogoutConfirmOpen(false)}>No</Button><Button themeColors={theme} variant="danger" onClick={() => { setCurrentUser(null); setIsLogoutConfirmOpen(false); }}>Si</Button></div></div></div></div> : null;
            
            // Factory Reset Modal
            const ResetConfirmModal = () => {
                if (!isResetConfirmOpen) return null;
                const [confirmText, setConfirmText] = useState('');
                return (
                    <div className="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in">
                        <div className="bg-slate-800 rounded-2xl w-full max-w-sm border border-red-500/50 shadow-2xl shadow-red-900/20">
                            <div className="p-4 border-b border-slate-700 flex justify-between items-center bg-red-500/10 rounded-t-2xl">
                                <h3 className="text-lg font-bold text-red-400 flex items-center gap-2"><AlertTriangle size={20}/> ZONA DE PELIGRO</h3>
                                <button onClick={() => setIsResetConfirmOpen(false)} className="text-slate-400 hover:text-white"><X size={20}/></button>
                            </div>
                            <div className="p-6 space-y-4">
                                <p className="text-slate-300 text-center text-sm">¬øEst√°s seguro? Esto borrar√° <b>TODOS</b> los datos (ventas, usuarios, inventario) permanentemente.</p>
                                <div className="space-y-2">
                                    <label className="text-xs text-slate-500 uppercase font-bold">Escribe "RESET" para confirmar</label>
                                    <input type="text" value={confirmText} onChange={e => setConfirmText(e.target.value)} placeholder="RESET" className="w-full bg-slate-950 border border-slate-700 rounded-lg p-2 text-center font-mono tracking-widest" />
                                </div>
                                <div className="grid grid-cols-2 gap-3 pt-2">
                                    <Button onClick={() => setIsResetConfirmOpen(false)} variant="secondary" themeColors={theme}>Cancelar</Button>
                                    <Button onClick={performFactoryReset} disabled={confirmText !== 'RESET'} className={confirmText === 'RESET' ? 'bg-red-600 hover:bg-red-500 text-white' : 'bg-slate-700 text-slate-500 cursor-not-allowed'}>BORRAR TODO</Button>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            const DailyCloseModal = () => {
                if (!isDailyCloseOpen) return null;
                const [confirming, setConfirming] = useState(false);
                const today = new Date().toISOString().split('T')[0];
                const currentShiftSales = sales.filter(s => s.date.startsWith(today) && !s.isClosed);
                const totalUSD = currentShiftSales.reduce((acc, s) => acc + s.totalUSD, 0);
                return (
                    <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4 backdrop-blur-sm animate-in fade-in">
                        <div className="bg-slate-800 rounded-2xl w-full max-w-md border border-slate-700 shadow-2xl flex flex-col max-h-[90vh]">
                            <div className="p-6 border-b border-slate-700 flex justify-between items-center"><div className={`flex items-center gap-2 ${theme.text}`}><Receipt size={24} /><h3 className="text-xl font-bold text-white">Cierre</h3></div><button onClick={() => setIsDailyCloseOpen(false)} className="text-slate-400 hover:text-white"><X size={24}/></button></div>
                            <div className="p-6 space-y-6 overflow-y-auto">
                                <div className="bg-slate-900 p-4 rounded-xl border border-slate-700 text-center"><p className={`${theme.text} text-xs uppercase font-bold mb-1`}>Ventas Turno</p><p className="text-2xl font-bold text-white">${totalUSD.toFixed(2)}</p></div>
                                {!confirming ? <Button themeColors={theme} onClick={() => setConfirming(true)} className="w-full" disabled={currentShiftSales.length === 0} variant="primary">{currentShiftSales.length === 0 ? "Sin Ventas" : "Cerrar D√≠a"}</Button> : <div className="bg-amber-500/10 border border-amber-500/50 p-4 rounded-xl animate-in fade-in"><div className="flex gap-3 mb-3"><AlertTriangle className="text-amber-500 shrink-0" /><div className="text-sm text-amber-200"><p className="font-bold mb-1">¬øConfirmar?</p><p className="text-xs">Esto reinicia la caja.</p></div></div><div className="grid grid-cols-2 gap-3"><Button themeColors={theme} onClick={() => setConfirming(false)} variant="secondary" className="text-xs">Cancelar</Button><Button themeColors={theme} onClick={() => performDailyClose(currentShiftSales)} variant="warning" className="text-xs">Confirmar</Button></div></div>}
                            </div>
                        </div>
                    </div>
                );
            };
            const Toast = () => notification ? <div className="fixed top-4 inset-x-0 mx-auto z-50 animate-in slide-in-from-top-5 fade-in duration-300 w-full max-w-sm px-4"><div className={`bg-slate-800 border ${theme.border}/50 text-white px-4 py-3 rounded-xl shadow-2xl flex items-center gap-3 w-full`}><div className={`${theme.lightBg} p-2 rounded-full ${theme.text}`}><CheckCircle2 size={24} /></div><div className="flex-1"><h4 className={`font-bold text-sm ${theme.text}`}>{notification.title}</h4><p className="text-xs text-slate-300">{notification.message}</p></div></div></div> : null;

            if (isLoading) return <div className="min-h-screen bg-slate-950 flex items-center justify-center text-emerald-500"><div className="animate-pulse flex flex-col items-center gap-4"><Beer size={48} /><span className="text-xs font-mono tracking-widest uppercase">Cargando Cloud...</span></div></div>;
            if (!currentUser) return <LoginScreen users={users} setCurrentUser={setCurrentUser} setView={setView} sales={sales} theme={theme} />;

            return (
                <div className={`min-h-screen bg-slate-950 text-slate-200 font-sans ${theme.selection}`}>
                    <Header />
                    <main className="animate-fade-in">
                        {view === 'dashboard' && <DashboardView sales={sales} theme={theme} />}
                        {view === 'pos' && (
                            <POSView 
                                menu={menu} 
                                cart={cart} 
                                sales={sales}
                                addToCart={addToCart} 
                                updateQty={updateQty} 
                                theme={theme} 
                                cartTotalUSD={cartTotalUSD} 
                                cartTotalVES={cartTotalVES} 
                                processSale={processSale} 
                                clearCart={clearCart} 
                                tasa={tasa} 
                                setIsSplitPaymentOpen={setIsSplitPaymentOpen} 
                                setIsMobileCartOpen={setIsMobileCartOpen} 
                                isMobileCartOpen={isMobileCartOpen} 
                                setIsCustomItemModalOpen={setIsCustomItemModalOpen}
                                setCustomItemBase={setCustomItemBase}
                            />
                        )}
                        {view === 'inventory' && currentUser.role === 'admin' && <InventoryView menu={menu} setMenu={setMenu} theme={theme} requestConfirm={requestConfirm} setNotification={setNotification} />}
                        {view === 'reports' && currentUser.role === 'admin' && <ReportsView sales={sales} theme={theme} setSales={setSales} handleVoidLastSale={handleVoidLastSale} />}
                        {view === 'users' && currentUser.role === 'admin' && <UsersView users={users} setUsers={setUsers} currentUser={currentUser} theme={theme} setNotification={setNotification} requestConfirm={requestConfirm} />}
                        
                        <div className="text-center py-4 text-[10px] text-slate-700 font-mono opacity-50 pb-24">concept & code by: @leonelo.jpg ft @xitocore</div>
                    </main>
                    <Navigation />
                    
                    {/* Modales Globales */}
                    <RateModal /> 
                    <LogoutConfirmModal /> 
                    <DailyCloseModal /> 
                    <ResetConfirmModal />
                    <MixedPaymentModal 
                        isOpen={isSplitPaymentOpen} 
                        onClose={() => setIsSplitPaymentOpen(false)} 
                        totalUSD={cartTotalUSD} 
                        onConfirm={processSale}
                        theme={theme}
                    />
                    <CustomItemModal 
                        isOpen={isCustomItemModalOpen}
                        onClose={() => setIsCustomItemModalOpen(false)}
                        onConfirm={addCustomToCart}
                        theme={theme}
                    />
                    <ConfirmationModal
                        isOpen={confirmConfig.isOpen}
                        onClose={() => setConfirmConfig(prev => ({...prev, isOpen: false}))}
                        title={confirmConfig.title}
                        message={confirmConfig.message}
                        onConfirm={confirmConfig.onConfirm}
                        theme={theme}
                    />
                    <Toast />
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>